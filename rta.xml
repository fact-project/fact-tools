<container>

    <properties url="classpath:/default/settings.properties" />


    <property name="auxfolder" value="file:/fhgfs/groups/app/fact/aux" />
    <property name="estimator" value="classpath:/prediction_test_files/estimator.pmml.gz" />
    <property name="separator" value="classpath:/prediction_test_files/model.pmml.gz" />
    <property name="jdbc" value="jdbc:sqlite:rta.sqlite" />
    <property name="infile" value="/fhgfs/groups/app/fact/raw/2013/11/08/"/>


    <property name="auxService" value="rta_service" />

    <service id="rta_service" class="fact.rta.WebSocketService" auxFolder="${auxfolder}"  jdbcConnection="${jdbc}"/>
    <service id="rf" class="fact.PredictionService" url="${separator}" />
    <service id="regressor" class="fact.PredictionService" url="${estimator}" />


    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixelDelayFile" value="classpath:/default/delays_lightpulser_20150217.csv" />

    <!--<service id="drsService" class="fact.DrsFileService" rawDataFolder="file:/fhgfs/groups/app/fact/raw/" />-->
    <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />


    <stream class="fact.rta.io.RTAStream" id="fact" folder="${infile}" jdbcConnection="${jdbc}" rtaService="rta_service">
        <stream id="_" class="fact.io.hdureader.FITSStream" limit="500" />
    </stream>


    <!-- Description of the process and the corresponding stream -->
    <process input="fact" copies="2">
        <!--<Delay time="50ms" />-->
        <Enqueue queues="performance_queue" keys="UnixTimeUTC"/>

        <Skip condition="%{data.TriggerType} != 4" />



        <include url="classpath:/default/data/prevEventAndSkip.xml" />
        <fact.datacorrection.DrsCalibration
                url="file:/fhgfs/groups/app/fact/raw/2013/11/08/20131108_041.drs.fits.gz"
                key="Data"
                outputKey="DataCalibrated"
        />
        <fact.datacorrection.PatchJumpRemoval
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                prevEventsKey="prevEvents"
                startCellKey="StartCellData"
                jumpLimit="${patchJumpRemoval_jumpLimit}"
        />
        <fact.datacorrection.RemoveSpikes
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                startCellKey="StartCellData"
                leftBorder="${removeSpikes_leftBorder}"
                spikeLimit="${removeSpikes_spikeLimit}"
                topSlopeLimit="${removeSpikes_topSlopeLimit}"
                maxSpikeLength="${removeSpikes_maxSpikeLength}"
        />
        <fact.datacorrection.DrsTimeCalibration
                dataKey="DataCalibrated"
                outputKey="timeCalibConst"
        />

        <fact.datacorrection.InterpolateTimeSeries
                calibService="calibService"
                dataKey="DataCalibrated"
                dataOutputKey="DataCalibrated"
        />
        <include url="classpath:/default/data/extraction.xml" />
        <include url="classpath:/default/data/cleaning.xml" />
        <include url="classpath:/default/data/parameterCalc.xml" />
        <include url="classpath:/default/data/sourceParameter.xml" />

        <Skip condition="%{data.numPixeInShower} &lt; 9" />

            <fact.rta.Energy predictor="regressor" />
            <fact.rta.Signal predictor="rf" webService="rta_service"/>
            <!--<Enqueue queues="out_queue" />-->
    </process>

    <process input="performance_queue">
        <fact.DataRate every="150" logmemory="true"  webService="rta_service"/>
    </process>

    <!--<process input="out_queue">-->
        <!--<fact.io.JSONWriter url="file:./rta.json" keys="@timestamp,signal:*,energy,background:*"/>-->
    <!--</process>-->

</container>

