<container>
		<property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
		<property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />

    <stream class="fact.io.FitsStream" id="fact" url="${infile}" />

    <property name="outfile" value="analysis-output.txt" />
    <property name="auxFolder" value="file:src/main/resources/aux/" />
    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixelDelayFile" value="classpath:/default/delays_lightpulser_20150217.csv" />

    <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="${auxFolder}" />
    <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />

    <process id="2" input="fact">
				<RenameKey from="Data" to="raw:data" />
				<fact.pixelsets.AllPixels outputKey="pixels" />
				<PrintData />
        <stream.flow.Skip condition="%{data.TriggerType} != 4" />
				<RenameKey from="StartCellData" to="meta:startCellData" />

        <fact.utils.PreviousEventInfo />
        <fact.datacorrection.DrsCalibration url="${drsfile}" />

        <fact.datacorrection.RemoveSpikes />

        <fact.filter.DrsTimeCalibration />
        <fact.filter.ArrayTimeCorrection />
        <fact.datacorrection.InterpolateTimeSeries calibService="calibService"/>

				<!-- Extract numEstPhotons -->
				<fact.extraction.BasicExtraction url="${integralGainFile}"/>
        <fact.extraction.EstimateBaseline />
        <fact.extraction.TimeOverThreshold />
        <fact.datacorrection.CorrectSaturation />
				<fact.extraction.BasicExtraction url="${integralGainFile}"/>

				<!-- Extract ArrivalTimes -->
        <fact.extraction.ArrivalTimeForPositions />
        <fact.extraction.ArrivalTimePolynomFit />
        <fact.datacorrection.CorrectPixelDelays url="${pixelDelayFile}"/>


        <fact.datacorrection.InterpolatePhotondata calibService="calibService"/>

				<!-- Statistical Features -->
        <fact.statistics.ArrayStatistics key="pixels:estNumPhotons"/>
        <fact.statistics.ArrayStatistics key="pixels:arrivalTimes"/>

        <fact.cleaning.TwoLevelTimeNeighbor calibService="calibService"/>
        <Skip condition="%{data.shower} == null" />

        <fact.pixelsets.NumPixel pixelSetKey="shower" />
        <Skip condition="%{data.shower:numPixel} &lt; 5" />

        <fact.statistics.ArrayStatistics key="pixels:estNumPhotons" pixelSetKey="shower" />
        <fact.statistics.ArrayStatistics key="pixels:arrivalTimes" pixelSetKey="shower" />
        <fact.statistics.ArrayStatistics key="pixels:maxSlopes" pixelSetKey="shower" />
        <fact.statistics.ArrayStatistics key="pixels:maxAmplitudePositions" pixelSetKey="shower" />

        <fact.features.Size />
        <fact.features.EllipseParameter/>
        <fact.features.NumberOfIslands/>
        <fact.features.TimeGradient />
				<fact.io.PrintKeysOnConsole keys="pixels:estNumPhotons"/>
        <fact.features.Concentration/>
        <fact.features.ConcentrationCore/>
        <fact.features.ConcentrationAtCenterOfGravity/>
        <fact.features.Leakage/>
        <fact.features.TimeSpread />
        <!-- <fact.features.ShowerSlope /> -->
        <fact.features.Disp />

				<fact.io.JSONWriter keys="pixels:*:*,shower:*" url="file:test.json" />
				<!-- <fact.ShowViewer key="raw:dataCalibrated"/> -->
    </process>
</container>
