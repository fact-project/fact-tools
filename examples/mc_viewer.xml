<container>
  <properties url="classpath:/default/settings.properties" />

  <!-- Pathes to the input files -->
  <property name="infile" value="file:src/main/resources/testMcFile.fits.gz" />
  <property name="drsfile" value="file:src/main/resources/testMcDrsFile.drs.fits.gz" />
  <property name="integral_gain_file" value="classpath:/default/defaultIntegralGains.csv" />

  <!-- The calibration service delivers aux data to the processors -->
  <service id="calib_service" class="fact.calibrationservice.ConstantCalibService" />

  <!-- Name of the stream and url to the input file -->
  <stream id="fact" class="fact.io.hdureader.FITSStream" url="${infile}" />

  <!-- Description of the process and the corresponding stream -->
  <process id="2" input="fact">

    <!-- Use standard calibration, extraction and cleaning -->
    <fact.utils.Remapping
            key="Data"
            outputKey="Data"
    />
    <fact.utils.RemappingKeys
            keys="McCherPhotWeight,McCherPhotNumber,McMuonCherPhotWeight,McNoisePhotWeight,McCherArrTimeMean,McCherArrTimeVar,McCherArrTimeMin,McCherArrTimeMax"
    />
    <fact.datacorrection.DrsCalibration
            url="${drsfile}"
            key="Data"
            outputKey="data_calibrated"
    />
    <fact.datacorrection.RemoveSpikes
            dataKey="data_calibrated"
            outputKey="data_calibrated"
            startCellKey="StartCellData"
            leftBorder="${remove_spikes_left_border}"
            spikeLimit="${remove_spikes_spike_limit}"
            topSlopeLimit="${remove_spikes_top_slope_limit}"
            maxSpikeLength="${remove_spikes_max_spike_length}"
    />
    <fact.datacorrection.InterpolateTimeSeries
            calibService="calib_service"
            dataKey="data_calibrated"
            dataOutputKey="data_calibrated"
    />

    <fact.extraction.BasicExtraction
            dataKey="data_calibrated"
            outputKeyMaxAmplPos="max_pos"
            outputKeyPhotonCharge="photoncharge"
            url="${integral_gain_file}"
            startSearchWindow="${basic_extraction_start_search_window}"
            rangeSearchWindow="${basic_extraction_range_search_window}"
            rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
    />
    <fact.extraction.EstimateBaseline
            dataKey="data_calibrated"
            outputKey="baseline"
            firstSlice="10"
            range="30"
    />
    <fact.extraction.TimeOverThreshold
            dataKey="data_calibrated"
            outputKey="time_over_threshold"
            firstSliceOverThresholdOutputKey="arrival_time_tot"
            positionsKey="max_pos"
            threshold="1800"
            thresholdOutputKey="threshold_for_tot"
    />
    <fact.datacorrection.CorrectSaturation
            dataKey="data_calibrated"
            outputKey="data_calibrated"
            totKey="time_over_threshold"
            firstSliceOverThresholdKey="arrival_time_tot"
            threshold="1800"
            maxPosKey="max_pos"
            baselineKey="baseline"
    />
    <fact.extraction.BasicExtraction
            dataKey="data_calibrated"
            outputKeyMaxAmplPos="max_pos"
            outputKeyPhotonCharge="photoncharge"
            url="${integral_gain_file}"
            startSearchWindow="${basic_extraction_start_search_window}"
            rangeSearchWindow="${basic_extraction_range_search_window}"
            rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
    />
    <fact.extraction.RisingEdgeForPositions
            dataKey="data_calibrated"
            amplitudePositionsKey="max_pos"
            outputKey="arrival_time_pos"
            maxSlopesKey="max_slopes_pos"
    />
    <fact.extraction.RisingEdgePolynomFit
            dataKey="data_calibrated"
            risingEdgeKey="arrival_time_pos"
            outputKey="arrival_time"
            numberOfPoints="${rising_edge_polynom_fit_number_of_points}"
            maxSlopesKey="max_slopes"
    />
    <fact.datacorrection.InterpolatePhotondata
            calibService="calib_service"
            photonChargeKey="photoncharge"
            photonChargeOutputKey="photoncharge"
            arrivalTimeKey="arrival_time"
            arrivalTimeOutputKey="arrival_time"
    />

    <fact.cleaning.TwoLevelTimeNeighbor
            calibService="calib_service"
            photonChargeKey="photoncharge"
            outputKey="shower"
            arrivalTimeKey="arrival_time"
            corePixelThreshold="${two_level_time_neighbor_core_threshold}"
            neighborPixelThreshold="${two_level_time_neighbor_neighbor_threshold}"
            timeLimit="${two_level_time_neighbor_time_limit}"
            minNumberOfPixel="${two_level_time_neighbor_min_number_of_pixel}"
    />

    <fact.pixelsets.Invert
            insetKey="badPixel"
            outsetKey="good_pixel"
    />

    <fact.pixelsets.Difference
            setUKey="good_pixel"
            setAKey="shower"
            outsetKey="pedestal"
    />

    <fact.extraction.WaveformFluctuation
            key="data_calibrated"
            pixelSetKey="good_pixel"
            outputKey="ped"
            skipFirst="35"
            skipLast="50"
            windowSize="30"
    />

    <fact.pixelsets.Length
            pixelSetKey="pedestal"
            outputKey="num_pixel_in_pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_mean"
            outputKey="ped_mean"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_std"
            outputKey="ped_std"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_var"
            outputKey="ped_var"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_kurtosis"
            outputKey="ped_kurtosis"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_max"
            outputKey="ped_max"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_min"
            outputKey="ped_min"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_skewness"
            outputKey="ped_skewness"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_median"
            outputKey="ped_median"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_sum"
            outputKey="ped_sum"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="phChargePedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="arrival_time"
            outputKey="arr_time_pedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="max_slopes"
            outputKey="max_slopes_pedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="arrival_time_pos"
            outputKey="arr_time_pos_pedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="max_slopes_pos"
            outputKey="max_slopes_pos_pedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="max_pos"
            outputKey="max_pos_pedestal"
            pixelSetKey="pedestal"
    />
    <fact.features.Size
            pixelSetKey="pedestal"
            photonChargeKey="photoncharge"
            outputKey="pedestal_size"
    />
    <fact.features.TimeSpread
            weightsKey="photoncharge"
            arrivalTimeKey="arrival_time"
            pixelSetKey="pedestal"
            outputKey="pedestal_timespread"
    />

    <fact.statistics.ArrayStatistics
            key="ped_mean"
            outputKey="fluct_mean"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_std"
            outputKey="fluct_std"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_var"
            outputKey="fluct_var"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_kurtosis"
            outputKey="fluct_kurtosis"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_max"
            outputKey="fluct_max"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_min"
            outputKey="fluct_min"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_skewness"
            outputKey="fluct_skewness"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_median"
            outputKey="fluct_median"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_sum"
            outputKey="fluct_sum"
            pixelSetKey="shower"
    />

    <fact.ShowViewer key="data_calibrated" />
  </process>
</container>
