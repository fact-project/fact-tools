<container>
  <properties url="classpath:/default/settings.properties" />
  <!-- Pathes to the input files -->
  <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
  <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />
  <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
  <property name="pixelDelayFile" value="classpath:/default/delays_lightpulser_20150217.csv" />
  <property name="auxFolder" value="file:src/main/resources/aux/" />

  <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="${auxFolder}" />
  <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />

  <stream id="fact" class="fact.io.hdureader.FITSStream" url="${infile}"/>

  <!-- Description of the process and the corresponding stream -->
  <process id="2" input="fact">

    <fact.utils.PreviousEventInfo startCellKey="StartCellData" outputKey="prevEvents" limitEvents="10" />
    <fact.datacorrection.DrsCalibration
            url="${drsfile}"
            key="Data"
            outputKey="DataCalibrated"
    />
    <fact.datacorrection.PatchJumpRemoval
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            prevEventsKey="prevEvents"
            startCellKey="StartCellData"
            jumpLimit="${patchJumpRemoval_jumpLimit}"
    />
    <fact.datacorrection.RemoveSpikes
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            startCellKey="StartCellData"
            leftBorder="${removeSpikes_leftBorder}"
            spikeLimit="${removeSpikes_spikeLimit}"
            topSlopeLimit="${removeSpikes_topSlopeLimit}"
            maxSpikeLength="${removeSpikes_maxSpikeLength}"
    />
    <fact.filter.DrsTimeCalibration
            outputKey="timeCalibConst"
    />
    <fact.filter.ArrayTimeCorrection
            dataKey="DataCalibrated"
            timeCalibConstKey="timeCalibConst"
            outputKey="DataCalibrated"
    />
    <fact.datacorrection.InterpolateTimeSeries
            calibService="calibService"
            dataKey="DataCalibrated"
            dataOutputKey="DataCalibrated"
    />

    <fact.extraction.BasicExtraction
            dataKey="DataCalibrated"
            outputKeyMaxAmplPos="maxPos"
            outputKeyPhotonCharge="photoncharge"
            url="${integralGainFile}"
            startSearchWindow="${basicExtraction_startSearchWindow}"
            rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
            rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
    />
    <fact.extraction.EstimateBaseline
            dataKey="DataCalibrated"
            outputKey="baseline"
            firstSlice="10"
            range="30"
    />
    <fact.extraction.TimeOverThreshold
            dataKey="DataCalibrated"
            outputKey="timeOverThreshold"
            firstSliceOverThresholdOutputKey="arrivalTimeTOT"
            positionsKey="maxPos"
            threshold="1800"
            thresholdOutputKey="thresholdForToT"
    />
    <fact.datacorrection.CorrectSaturation
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            totKey="timeOverThreshold"
            firstSliceOverThresholdKey="arrivalTimeTOT"
            threshold="1800"
            maxPosKey="maxPos"
            baselineKey="baseline"
    />
    <fact.extraction.BasicExtraction
            dataKey="DataCalibrated"
            outputKeyMaxAmplPos="maxPos"
            outputKeyPhotonCharge="photoncharge"
            url="${integralGainFile}"
            startSearchWindow="${basicExtraction_startSearchWindow}"
            rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
            rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
    />
    <fact.extraction.RisingEdgeForPositions
            dataKey="DataCalibrated"
            amplitudePositionsKey="maxPos"
            outputKey="arrivalTimePos"
            maxSlopesKey="maxSlopesPos"
    />
    <fact.extraction.RisingEdgePolynomFit
            dataKey="DataCalibrated"
            risingEdgeKey="arrivalTimePos"
            outputKey="arrivalTime"
            numberOfPoints="11"
            maxSlopesKey="maxSlopes"
    />
    <fact.datacorrection.CorrectPixelDelays
            arrivalTimeKey="arrivalTime"
            outputKey="arrivalTime"
            url="${pixelDelayFile}"
    />
    <fact.datacorrection.InterpolatePhotondata
            calibService="calibService"
            photonChargeKey="photoncharge"
            photonChargeOutputKey="photoncharge"
            arrivalTimeKey="arrivalTime"
            arrivalTimeOutputKey="arrivalTime"
    />

    <fact.features.source.SourcePosition
            outputKey="Cetatauri"
            sourceRightAscension="5.627416667"
            sourceDeclination="21.1425"
            auxService="auxService"
    />

    <fact.cleaning.TwoLevelTimeNeighbor
            calibService="calibService"
            photonChargeKey="photoncharge"
            outputKey="shower"
            arrivalTimeKey="arrivalTime"
            corePixelThreshold="${twoLevelTimeNeighbor_coreThreshold}"
            neighborPixelThreshold="${twoLevelTimeNeighbor_neighborThreshold}"
            timeLimit="${twoLevelTimeNeighbor_timeLimit}"
            minNumberOfPixel="${twoLevelTimeNeighbor_minNumberOfPixel}"
            starPositionKeys="Cetatauri"
            starRadiusInCamera="11.0"
    />

    <fact.pixelsets.Invert
            insetKey="badPixel"
            outsetKey="goodPixel"
    />

    <fact.pixelsets.Difference
            setUKey="goodPixel"
            setAKey="shower"
            outsetKey="pedestal"
    />

    <fact.extraction.WaveformFluctuation
            key="DataCalibrated"
            pixelSetKey="goodPixel"
            outputKey="ped"
            skipFirst="35"
            skipLast="50"
            windowSize="30"
    />

    <fact.pixelsets.Length
            pixelSetKey="pedestal"
            outputKey="numPixelInPedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_mean"
            outputKey="ped_mean"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_std"
            outputKey="ped_std"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_var"
            outputKey="ped_var"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_kurtosis"
            outputKey="ped_kurtosis"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_max"
            outputKey="ped_max"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_min"
            outputKey="ped_min"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_skewness"
            outputKey="ped_skewness"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_median"
            outputKey="ped_median"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="ped_sum"
            outputKey="ped_sum"
            pixelSetKey="pedestal"
    />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="phChargePedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="arrivalTime"
            outputKey="arrTimePedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="maxSlopes"
            outputKey="maxSlopesPedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="arrivalTimePos"
            outputKey="arrTimePosPedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="maxSlopesPos"
            outputKey="maxSlopesPosPedestal"
            pixelSetKey="pedestal"
    />
    <fact.statistics.ArrayStatistics
            key="maxPos"
            outputKey="maxPosPedestal"
            pixelSetKey="pedestal"
    />
    <fact.features.Size
            pixelSetKey="pedestal"
            photonChargeKey="photoncharge"
            outputKey="pedestalSize"
    />
    <fact.features.TimeSpread
            weightsKey="photoncharge"
            arrivalTimeKey="arrivalTime"
            pixelSetKey="pedestal"
            outputKey="pedestalTimespread"
    />

    <fact.statistics.ArrayStatistics
            key="ped_mean"
            outputKey="fluct_mean"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_std"
            outputKey="fluct_std"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_var"
            outputKey="fluct_var"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_kurtosis"
            outputKey="fluct_kurtosis"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_max"
            outputKey="fluct_max"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_min"
            outputKey="fluct_min"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_skewness"
            outputKey="fluct_skewness"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_median"
            outputKey="fluct_median"
            pixelSetKey="shower"
    />

    <fact.statistics.ArrayStatistics
            key="ped_sum"
            outputKey="fluct_sum"
            pixelSetKey="shower"
    />


    <fact.photonstream.SinglePulseExtraction
        dataKey="DataCalibrated"
        outputKey="PhotonArrivals"
    />

    <fact.photonstream.ConvertSinglePulses2Timeseries
      singlePulsesKey="PhotonArrivals"
      baseLineKey="PhotonArrivalsBaseLine"
      timeSeriesKey="ReconstructedDataCalibrated"
    />

    <fact.ShowViewer key="DataCalibrated" />
  </process>
</container>
