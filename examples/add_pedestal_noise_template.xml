<container>
    <!-- This xml takes a given mc set and adds the choosen data noise onto the event.
         The Creator will be changed from Ceres -> Ceres_Pedestal
        @parameters SET_noiseDB    The noise database jsonl file created from the fact-eventlist.
        @parameters SET_dataFolder The folder containing the fact files, structured in the fact data folder convention.
        @parameters input          The multidata json file (see processor). Containing the MC data which should be added.
        @output     output         The name of the finished fits file.
    -->
    <properties url="classpath:/default/settings.properties" />

    <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />
    
    
    <property name="noiseDB" value="file:${SET_noiseDB}" />
    <property name="dataFolder" value="${SET_dataFolder}" />
    <property name="noiseBinning" value="2" />

    <property name="LONS_KEYS" value="LONS_NIGHT,LONS_RUNID,LONS_EventNum,LONS_UnixTimeUTC"/>
    <property name="MC_KEYS" value="IncidentAngle.fVal,MCorsikaEvtHeader.fEvtNumber,MCorsikaEvtHeader.fNumReuse,MCorsikaEvtHeader.fTotalEnergy,MCorsikaEvtHeader.fStartAltitude,MCorsikaEvtHeader.fFirstTargetNum,CorsikaEvtHeader.fFirstInteractionHeight,MCorsikaEvtHeader.fMomentumX,MCorsikaEvtHeader.fMomentumY,MCorsikaEvtHeader.fMomentumZ,MCorsikaEvtHeader.fZd,MCorsikaEvtHeader.fAz,MCorsikaEvtHeader.fX,MCorsikaEvtHeader.fY,MCorsikaEvtHeader.fWeightedNumPhotons,MMcEvt.fEvtNumber,MMcEvt.fThick0,MMcEvt.fFirstTarget,MMcEvt.fZFirstInteraction,MMcEvt.fCoreD,MMcEvt.fCoreX,MMcEvt.fCoreY,MMcEvt.fTimeFirst,MMcEvt.fTimeLast,MMcEvt.fLongiNmax,MMcEvt.fLongit0,MMcEvt.fLongitmax,MMcEvt.fLongia,MMcEvt.fLongib,MMcEvt.fLongic,MMcEvt.fLongichi2,MMcEvt.fPhotIni,MMcEvt.fPassPhotAtm,MMcEvt.fPassPhotRef,MMcEvt.fPassPhotCone,MMcEvt.fPhotElfromShower,MMcEvt.fPhotElinCamera,MMcEvt.fElecCphFraction,MMcEvt.fMuonCphFraction,MMcEvt.fOtherCphFraction,MMcEvt.fFadcTimeJitter,MMcEvt.fEventReuse,MMcEvtBasic.fEnergy,MMcEvtBasic.fImpact,MMcEvtBasic.fTelescopePhi,MMcEvtBasic.fTelescopeTheta,MMcEvtBasic.fTheta,MMcEvtBasic.fPhi,MPointingPos.fZd,MPointingPos.fAz,MPointingPos.fRa,MPointingPos.fHa,MPointingPos.fDec,MRawEvtData.fHiGainPixId,Data,StartCellData,TriggerType,MRawEvtData.fNumBytesPerSample,MRawEvtData.fIsSigned,EventNum,MRawEvtHeader.fNumTrigLvl1,MRawEvtHeader.fTrigPattern,MSimSourcePos.fZd,MSimSourcePos.fAz,MSimSourcePos.fRa,MSimSourcePos.fHa,MSimSourcePos.fDec,McCherPhotWeight,McCherPhotNumber,McMuonCherPhotWeight,McMuonCherPhotNumber,McNoisePhotWeight,McCherArrTimeMean,McCherArrTimeVar,McCherArrTimeMin,McCherArrTimeMax"/>
    
    <property name="OUTPUT_KEYS" value="${MC_KEYS},${LONS_KEYS}"/>

    <stream id="fact" class="fact.io.FactFileListMultiStream"   url="${input}">
        <stream class="fact.io.hdureader.FITSStream" id="fact" />
    </stream>

    <process id="1" input="fact">
        <fact.utils.Remapping
                key="Data"
                outputKey="Data"
        />

        <fact.datacorrection.DrsCalibration
                key="Data"
                outputKey="DataCalibrated"
        />

        <fact.datacorrection.RemoveSpikes
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            startCellKey="StartCellData"
            leftBorder="${RemoveSpikes.leftBorder}"
            spikeLimit="${RemoveSpikes.spikeLimit}"
            topSlopeLimit="${RemoveSpikes.topSlopeLimit}"
            maxSpikeLength="${RemoveSpikes.maxSpikeLength}"
        />
        <fact.datacorrection.InterpolateTimeSeries
                calibService="calibService"
                dataKey="DataCalibrated"
                dataOutputKey="DataCalibrated"
        />
        
        
    <!-- Sample Pedestal Event and calibrate it -->	
        <fact.utils.SamplePedestalEvent prependKey="LONS_" noiseDatabase="${noiseDB}" dataFolder="${dataFolder}"
                                        dbBinningKey="Zd" itemBinningKey="MPointingPos.fZd" binning="${noiseBinning}"
        />
        
        <fact.features.UnixTimeUTC2DateTime inputKey="LONS_UnixTimeUTC" outputKey="LONS_timestamp" />
    
        <fact.datacorrection.DrsCalibration
                drsKey="LONS_drspath"
                key="LONS_Data"
                outputKey="LONS_DataCalibrated"
                startCellKey="LONS_StartCellData"
        />

        <fact.datacorrection.PatchJumpRemoval
                dataKey="LONS_DataCalibrated"
                outputKey="LONS_DataCalibrated"
                prevEventsKey="LONS_prevEvents"
                startCellKey="LONS_StartCellData"
                unixTimeKey="LONS_UnixTimeUTC"
                jumpLimit="${PatchJumpRemoval.jumpLimit}"
        />

         <fact.datacorrection.RemoveSpikes
                dataKey="LONS_DataCalibrated"
                outputKey="LONS_DataCalibrated"
                startCellKey="LONS_StartCellData"
                leftBorder="${RemoveSpikes.leftBorder}"
                spikeLimit="${RemoveSpikes.spikeLimit}"
                topSlopeLimit="${RemoveSpikes.topSlopeLimit}"
                maxSpikeLength="${RemoveSpikes.maxSpikeLength}"
        />

        <fact.datacorrection.DrsTimeCalibration
                startCellKey = "LONS_StartCellData"
                dataKey      = "LONS_DataCalibrated"
                outputKey    = "LONS_DataCalibrated"
        />

        <fact.datacorrection.InterpolateTimeSeries
                calibService="calibService"
                dataKey="LONS_DataCalibrated"
                dataOutputKey="LONS_DataCalibrated"
                badPixelKey="LONS_badPixel"
                timeStampKey="LONS_timestamp"
        />

        <fact.utils.CombineDataArrays firstArrayKey="DataCalibrated" secondArrayKey="LONS_DataCalibrated"
                                      outputKey="DataCalibrated" op="add"/>
        
         <fact.datacorrection.DrsCalibration
                key="DataCalibrated"
                outputKey="Data"
                reverse="true"
        />
        <fact.utils.Remapping
                key="Data"
                outputKey="Data"
                reverse="True"
        />
        
        <stream.script.JavaScript>
            function process(item){
                item.put( "CREATOR", "Ceres_Pedestal" );
                return item;
            }
        </stream.script.JavaScript>
        
        <!--<fact.ShowViewer key="DataCalibrated" />-->

        <fact.io.FITSWriter url="${output}"
                            keys="${OUTPUT_KEYS}"
                            headerKeys="CREATOR,NROI,NPIX,TELESCOP,RUNTYPE,CAMERA"
        />
    </process>
</container>