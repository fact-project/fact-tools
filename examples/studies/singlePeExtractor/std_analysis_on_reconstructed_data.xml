<container>

    <properties url="classpath:/default/settings.properties" />

    <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
    <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />

    <property name="integral_gain_file" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixel_delay_file" value="classpath:/default/delays_lightpulser_20150217.csv" />

    <property name="output" value="file:testoutfile.json" />

    <property name="aux_folder" value="file:src/main/resources/aux/" />
    <service id="aux_service" class="fact.auxservice.AuxFileService" auxFolder="${aux_folder}" />

    <service id="calib_service" class="fact.calibrationservice.ConstantCalibService" />

    <!--In case you want to analyze .zfits files.-->
    <!-- <stream id="fact" class="fact.io.zfits.ZFitsStream"  url="${infile}"/> -->

    <stream id="fact" class="fact.io.hdureader.FITSStream" url="${infile}"/>

    <process id="2" input="fact">
        <!-- prevEventAndSkip: -->
        <!-- PreviousEventInfo, Skip(no Data Trigger) -->
        <fact.utils.PreviousEventInfo
                startCellKey="StartCellData"
                outputKey="prev_events"
                limitEvents="${prev_events_limit_events}"
        />
        <stream.flow.Skip condition="%{data.TriggerType} != 4" />
        <!-- Output: Data -->

        <!-- Calibration: -->
        <!-- DrsCalibration, PatchJumpRemoval, RemoveSpikes,
        DrsTimeCalibration, ArrayTimeCorrection, InterpolateBadPixel -->
        <fact.datacorrection.DrsCalibration
                url="${drsfile}"
                key="Data"
                outputKey="data_calibrated"
        />
        <fact.datacorrection.PatchJumpRemoval
                dataKey="data_calibrated"
                outputKey="data_calibrated"
                prevEventsKey="prev_events"
                startCellKey="StartCellData"
                jumpLimit="${patch_jump_removal_jump_limit}"
        />
        <fact.datacorrection.RemoveSpikes
                dataKey="data_calibrated"
                outputKey="data_calibrated"
                startCellKey="StartCellData"
                leftBorder="${remove_spikes_left_border}"
                spikeLimit="${remove_spikes_spike_limit}"
                topSlopeLimit="${remove_spikes_top_slope_limit}"
                maxSpikeLength="${remove_spikes_max_spike_length}"
        />
        <fact.filter.DrsTimeCalibration
                outputKey="time_calib_const"
        />
        <fact.filter.ArrayTimeCorrection
                dataKey="data_calibrated"
                timeCalibConstKey="time_calib_const"
                outputKey="data_calibrated"
        />
        <fact.datacorrection.InterpolateTimeSeries
                calibService="calib_service"
                dataKey="data_calibrated"
                dataOutputKey="data_calibrated"
        />
        <!-- Output: data_calibrated -->

        <!-- Single Pe Extraction -->
        <fact.photonstream.SinglePulseExtraction
                dataKey="data_calibrated"
                outputKey="PhotonArrivals"
        />

        <!-- Data Time Series Reconstruction from Single Pe Data -->
        <fact.photonstream.ConvertSinglePulses2Timeseries
                singlePulsesKey="PhotonArrivals"
                baseLineKey="PhotonArrivalsBaseLine"
                timeSeriesKey="data_calibrated"
        />


        <!-- Extraction -->
        <!-- BasicExtraction, RisingEdgeForPositions, RisingEdgePolynomFit, TimeOverThreshold,
        PhotonChargeTimeOverThreshold, HandleSaturation, CorrectPixelDelays-->
        <fact.extraction.BasicExtraction
                dataKey="data_calibrated"
                outputKeyMaxAmplPos="max_pos"
                outputKeyPhotonCharge="photoncharge"
                url="${integral_gain_file}"
                startSearchWindow="${basic_extraction_start_search_window}"
                rangeSearchWindow="${basic_extraction_range_search_window}"
                rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
        />
        <fact.extraction.EstimateBaseline
                dataKey="data_calibrated"
                outputKey="baseline"
                firstSlice="10"
                range="30"
        />
        <fact.extraction.TimeOverThreshold
                dataKey="data_calibrated"
                outputKey="time_over_threshold"
                firstSliceOverThresholdOutputKey="arrival_time_tot"
                positionsKey="max_pos"
                threshold="1800"
                thresholdOutputKey="threshold_for_tot"
        />
        <fact.datacorrection.CorrectSaturation
                dataKey="data_calibrated"
                outputKey="data_calibrated"
                totKey="time_over_threshold"
                firstSliceOverThresholdKey="arrival_time_tot"
                threshold="1800"
                maxPosKey="max_pos"
                baselineKey="baseline"
        />
        <fact.extraction.BasicExtraction
                dataKey="data_calibrated"
                outputKeyMaxAmplPos="max_pos"
                outputKeyPhotonCharge="photoncharge"
                url="${integral_gain_file}"
                startSearchWindow="${basic_extraction_start_search_window}"
                rangeSearchWindow="${basic_extraction_range_search_window}"
                rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
        />
        <fact.extraction.RisingEdgeForPositions
                dataKey="data_calibrated"
                amplitudePositionsKey="max_pos"
                outputKey="arrival_time_pos"
                maxSlopesKey="max_slopes_pos"
        />
        <fact.extraction.RisingEdgePolynomFit
                dataKey="data_calibrated"
                risingEdgeKey="arrival_time_pos"
                outputKey="arrival_time"
                numberOfPoints="11"
                maxSlopesKey="max_slopes"
        />
        <fact.datacorrection.CorrectPixelDelays
                arrivalTimeKey="arrival_time"
                outputKey="arrival_time"
                url="${pixel_delay_file}"
        />
        <fact.datacorrection.InterpolatePhotondata
                calibService="calib_service"
                photonChargeKey="photoncharge"
                photonChargeOutputKey="photoncharge"
                arrivalTimeKey="arrival_time"
                arrivalTimeOutputKey="arrival_time"
        />
        <!-- Output: photoncharge, arrivalTime -->

        <!-- Cleaning -->
        <!-- SourcePosition(Cetatauri), CoreNeighborCleanTimeNeighbor-->
        <fact.features.source.SourcePosition
                outputKey="cetatauri"
                sourceRightAscension="5.627416667"
                sourceDeclination="21.1425"
                auxService="aux_service"
        />

        <fact.cleaning.TwoLevelTimeNeighbor
                calibService="calib_service"
                photonChargeKey="photoncharge"
                outputKey="shower"
                arrivalTimeKey="arrival_time"
                corePixelThreshold="${two_level_time_neighbor_core_threshold}"
                neighborPixelThreshold="${two_level_time_neighbor_neighbor_threshold}"
                timeLimit="${two_level_time_neighbor_time_limit}"
                minNumberOfPixel="${two_level_time_neighbor_min_number_of_pixel}"
                starPositionKeys="cetatauri"
                starRadiusInCamera="11.0"
        />
        <!-- Output: shower -->

        <!-- Parameter calculation (only source independent) -->
        <!-- ArrayMean(photoncharge,arrivalTime), ArrayStatistics(photoncharge,arrivalTime,maxSlopes,
        arrivalTimePos,maxSlopesPos,maxAmplitudePosition,photonchargeSaturated,arrivalTimeTOT),
        Size, HillasParameter, M3Long, Length, Width, NumberOfIslands, TimeGraident,
        Concentration, ConcentrationCore, ConcentrationAtCenterOfGravity, Leakage, TimeSpread,
        ShowerSlope, Disp -->
        <Skip condition="%{data.shower} == null" />
        <fact.pixelsets.Length
                pixelSetKey="shower"
                outputKey="num_pixel_in_shower"
        />
        <Skip condition="%{data.num_pixel_in_shower} &lt; 5" />

        <fact.statistics.ArrayMean
                key="photoncharge"
                outputKey="photoncharge_mean"
        />
        <fact.statistics.ArrayMean
                key="arrival_time"
                outputKey="arrival_time_mean"
        />
        <fact.statistics.ArrayStatistics
                key="photoncharge"
                outputKey="ph_charge_shower"
                pixelSetKey="shower"
        />
        <fact.statistics.ArrayStatistics
                key="arrival_time"
                outputKey="arr_time_shower"
                pixelSetKey="shower"
        />
        <fact.statistics.ArrayStatistics
                key="max_slopes"
                outputKey="max_slopes_shower"
                pixelSetKey="shower"
        />
        <fact.statistics.ArrayStatistics
                key="arrival_time_pos"
                outputKey="arr_time_pos_shower"
                pixelSetKey="shower"
        />
        <fact.statistics.ArrayStatistics
                key="max_slopes_pos"
                outputKey="max_slopes_pos_shower"
                pixelSetKey="shower"
        />
        <fact.statistics.ArrayStatistics
                key="max_pos"
                outputKey="max_pos_shower"
                pixelSetKey="shower"
        />

        <fact.features.HillasParameter
                weightsKey="photoncharge"
                pixelSetKey="shower"
                outputKey="shower_distribution"
                m3longKey="m3_long"
                m3transKey="m3_trans"
                m4longKey="m4_long"
                m4transKey="m4_trans"
                cogxKey="cog_x"
                cogyKey="cog_y"
                lengthKey="length"
                widthKey="width"
                deltaKey="delta"
                sizeKey="size"
                c0="117.94"
                dispKey="disp"
        />

        <fact.features.TimeGradient
                pixelSetKey="shower"
                arrivalTimeKey="arrival_time"
                cogxKey="cog_y"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKeySlope="timeGradientSlope"
                outputKeyIntercept="timeGradientIntercept"
                outputKeySumSquaredErrors="timeGradientSSE"
        />
        <fact.features.Concentration
                weights="photoncharge"
                pixelSetKey="shower"
                concOneOutputKey="concentration_one_pixel"
                concTwoOutputKey="concentration_two_pixel"
        />
        <fact.features.ConcentrationCore
                cogxKey="cog_x"
                cogyKey="cog_y"
                pixelSetKey="shower"
                photonChargeKey="photoncharge"
                sizeKey="size"
                widthKey="width"
                lengthKey="length"
                deltaKey="delta"
                outputKey="conc_core"
        />
        <fact.features.ConcentrationAtCenterOfGravity
                photonChargeKey="photoncharge"
                cogxKey="cog_x"
                cogyKey="cog_y"
                sizeKey="size"
                outputKey="conc_cog"
        />
        <fact.features.Leakage
                distribution="shower_distribution"
                pixelSetKey="shower"
                weights="photoncharge"
                leakage1OutputKey="leakage"
                leakage2OutputKey="leakage2"
        />
        <fact.features.TimeSpread
                weightsKey="photoncharge"
                arrivalTimeKey="arrival_time"
                pixelSetKey="shower"
                outputKey="timespread"
        />
        <fact.features.ShowerSlope
                photonChargeKey="photoncharge"
                arrivalTimeKey="arrival_time"
                pixelSetKey="shower"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                slopeLongOutputKey="slope_long"
                slopeTransOutputKey="slope_trans"
                slopeSpreadOutputKey="slope_spread"
                slopeSpreadWeightedOutputKey="slope_spread_weighted"
        />
        <!-- Output: source independent parameters -->

        <!-- Parameter calculation (only source dependent) -->
        <!-- SourcePosition(${sourcename}), AntiSourcePosition(5), Alpha(for 6 Sources),
        Distance(for 6 Sources), CosDeltaAlpha(for 6 Sources), Theta(for 6 Sources) -->
        <fact.features.source.SourcePosition
                outputKey="source_position"
                auxService="aux_service"

        />
        <fact.features.source.AntiSourcePosition
                sourcePositionKey="source_position"
                numberOfAntiSourcePositions="5"
                antiSourcePositionId="1"
                outputKey="anti_source_position_1"
        />
        <fact.features.source.AntiSourcePosition
                sourcePositionKey="source_position"
                numberOfAntiSourcePositions="5"
                antiSourcePositionId="2"
                outputKey="anti_source_position_2"
        />
        <fact.features.source.AntiSourcePosition
                sourcePositionKey="source_position"
                numberOfAntiSourcePositions="5"
                antiSourcePositionId="3"
                outputKey="anti_source_position_3"
        />
        <fact.features.source.AntiSourcePosition
                sourcePositionKey="source_position"
                numberOfAntiSourcePositions="5"
                antiSourcePositionId="4"
                outputKey="anti_source_position_4"
        />
        <fact.features.source.AntiSourcePosition
                sourcePositionKey="source_position"
                numberOfAntiSourcePositions="5"
                antiSourcePositionId="5"
                outputKey="anti_source_position_5"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="source_position"
                outputKey="alpha"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="source_position"
                outputKey="distance"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="anti_source_position_1"
                outputKey="alpha_off_1"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="anti_source_position_1"
                outputKey="distance_off_1"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="anti_source_position_2"
                outputKey="alpha_off_2"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="anti_source_position_2"
                outputKey="distance_off_2"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="anti_source_position_3"
                outputKey="alpha_off_3"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="anti_source_position_3"
                outputKey="distance_off_3"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="anti_source_position_4"
                outputKey="alpha_off_4"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="anti_source_position_4"
                outputKey="distance_off_4"
        />
        <fact.features.source.Alpha
                distribution="shower_distribution"
                sourcePosition="anti_source_position_5"
                outputKey="alpha_off_5"
        />
        <fact.features.source.Distance
                distribution="shower_distribution"
                sourcePosition="anti_source_position_5"
                outputKey="distance_off_5"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="source_position"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="anti_source_position_1"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha_off_1"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="anti_source_position_2"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha_off_2"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="anti_source_position_3"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha_off_3"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="anti_source_position_4"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha_off_4"
        />
        <fact.features.source.CosDeltaAlpha
                sourcePositionKey="anti_source_position_5"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                outputKey="cos_delta_alpha_off_5"
        />
        <fact.features.source.Theta
                sourcePositionKey="source_position"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha"
                signM3lConstant="-200"
                outputKey="theta"
        />
        <fact.features.source.Theta
                sourcePositionKey="anti_source_position_1"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha_off_1"
                signM3lConstant="-200"
                outputKey="theta_off_1"
        />
        <fact.features.source.Theta
                sourcePositionKey="anti_source_position_2"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha_off_2"
                signM3lConstant="-200"
                outputKey="theta_off_2"
        />
        <fact.features.source.Theta
                sourcePositionKey="anti_source_position_3"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha_off_3"
                signM3lConstant="-200"
                outputKey="theta_off_3"
        />
        <fact.features.source.Theta
                sourcePositionKey="anti_source_position_4"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha_off_4"
                signM3lConstant="-200"
                outputKey="theta_off_4"
        />
        <fact.features.source.Theta
                sourcePositionKey="anti_source_position_5"
                dispKey="disp"
                cogxKey="cog_x"
                cogyKey="cog_y"
                deltaKey="delta"
                m3lKey="m3_long"
                cosDeltaAlphaKey="cos_delta_alpha_off_5"
                signM3lConstant="-200"
                outputKey="theta_off_5"
        />
        <!-- Output: source dependent parameters -->

        <!--<fact.ShowViewer key="data_calibrated" />-->

        <!--<fact.io.JSONWriter keys="${keys_for_output}"-->
        <!--url="${output}"-->
        <!--writeListOfItems="True"-->
        <!--pixelSetsAsInt="True"-->
        <!--/>-->
    </process>
</container>
