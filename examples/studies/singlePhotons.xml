<container>
    <properties url="classpath:/default/settings.properties" />
    <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
    <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />
    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />

    <!-- Services -->
    <property name="pixelDelayFile" value="classpath:/default/delays_20141114.csv" />
    <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="file:src/main/resources/aux/" />

    <!-- Open Shutter Data: -->
    <!-- <property name="data" value="/local/data/kgray/test/20130104_095.fits.gz" />  -->
    <!-- <property name="dataDRS" value="/local/data/kgray/test/20130104_076.drs.fits.gz" /> -->
    <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />

    <stream id="fact" class="fact.io.zfits.ZFitsStream" url="${infile}" />
    <process input="fact">
        <fact.utils.PreviousEventInfo
        startCellKey="StartCellData"
        outputKey="prevEvents"
        limitEvents="10"
        />

        <stream.flow.Skip condition="%{data.EventNum} &lt; 0" />

        <!--         <stream.flow.Skip condition="%{data.TriggerType} != 4" /> -->
        <fact.datacorrection.DrsCalibration
        url="${drsfile}"
        key="Data"
        outputKey="DataCalibrated"
        />

        <fact.datacorrection.PatchJumpRemoval
        dataKey="DataCalibrated"
        outputKey="DataCalibrated"
        prevEventsKey="prevEvents"
        startCellKey="StartCellData"
        jumpLimit="${patchJumpRemoval_jumpLimit}"
        />

        <fact.datacorrection.RemoveSpikes
        dataKey="DataCalibrated"
        outputKey="DataCalibrated"
        startCellKey="StartCellData"
        leftBorder="${removeSpikes_leftBorder}"
        spikeLimit="${removeSpikes_spikeLimit}"
        topSlopeLimit="${removeSpikes_topSlopeLimit}"
        maxSpikeLength="${removeSpikes_maxSpikeLength}"
        />

        <fact.filter.DrsTimeCalibration
        outputKey="timeCalibConst"
        />

        <fact.filter.ArrayTimeCorrection
        dataKey="DataCalibrated"
        timeCalibConstKey="timeCalibConst"
        outputKey="DataCalibrated"
        />

        <!--<fact.filter.MovingAverage-->
        <!--key="DataCalibrated"-->
        <!--outputKey="DataSmoothed"-->
        <!--length="5"-->
        <!--/>-->

        <fact.filter.GaussConvolution
        key="DataCalibrated"
        outputKey="DataSmoothed"
        variance="1"
        />

        <fact.features.singlePulse.FindThresholdCrossings
        key="DataSmoothed"
        outputKey="StartPositions"
        visualizeOutputKey="PositionPulseCandidates"
        minBelow="4" minAbove="9" threshold="5.0"
        />

        <fact.features.singlePulse.PulseMaxAmplitude
        key="DataSmoothed"
        outputKey="PulseMaxAmp"
        pulsePositionKey="StartPositions"
        />

        <fact.features.singlePulse.ArrivalTime
        key="DataSmoothed"
        outputKey="ArrivalTimes"
        maxAmpPositionKey="PulseMaxAmp"
        visualizeKey="halfMaxArrivalTimes"
        />

        <fact.filter.ShapeSignal
        key="DataSmoothed"
        outputKey="DataShaped"
        shift="10"
        />

        <fact.statistics.Derivation
                key="DataSmoothed"
                outputKey="slopeKey"
        />

        <fact.filter.MovingLinearFit
                key="DataShaped"
                slopeKey="slope5"
                interceptKey="intercept5"
                scale="10"
                width="5"
        />

        <fact.features.singlePulse.ArrivalTimeFromSlope
                key="DataSmoothed"
                outputKey="ArrivalTimesSlope"
                derivationKey="slopeKey"
                visualizeKey="slopeArrivalTimes"
                baselineKey="baselines"
                skipFirstSlices="20"
                skipLastSlices="120"
        />


        <fact.features.singlePulse.PulseSizeCalculator
                key="DataSmoothed"
                arrivalTimeKey="ArrivalTimes"
                outputKey="pulseIntegrals"
                width="30"
        />


        <fact.features.singlePulse.PulseSlopeCalculator
                key="DataSmoothed"
                arrivalTimeKey="ArrivalTimes"
                outputKey="PulseSlopes"
                width="2"
        />

        <fact.features.singlePulse.PulseSlopeCalculatorPolynom
                key="DataSmoothed"
                risingEdgesKey="ArrivalTimes"
                outputKey="pulsePolynom"
        />


        <fact.utils.SelectArrayByChid
                key="pulsePolynom_slopes"
                chid="150"
                outputKey="PulseSlopes_pix"
        />

        <fact.plotter.HistogramArrayPlotter
                key="PulseSlopes_pix"
                binWidth="0.05"
                logAxis="true"
                color="#667695"
        />


        <!--<fact.filter.GaussConvolution key="DataCalibrated" outputKey="DataSmoothed10" variance="10" />-->
        <!--  For Closed Shutter Data: Threshold Extraction Method -->
        <!--  For Open Shutter Data: Slope Extraction Method -->
        <!--<fact.filter.MovingLinearFit key="DataShaped" slopeKey="slope7"  interceptKey="intercept7"  scale="10" width="7"/>-->
        <!--<fact.filter.MovingLinearFit key="DataShaped" slopeKey="slope14" interceptKey="intercept14" scale="10" width="14"/>-->
        <!--<fact.filter.MovingLinearFit key="DataShaped" slopeKey="slope20" interceptKey="intercept20" scale="10" width="20"/>-->
        <!--<fact.features.singlePulse.OpenShutterPulseSize key="DataSmoothed" outputKey="OpenPulseSizesSlope" arrivalTimeKey="ArrivalTimesSlope" baselineKey="baselines" width="30" />-->
        <!--<fact.io.JSONWriter url="file:/net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/jbuss/test.json" keys="OpenPulseSizesSlope,ArrivalTimesSlope,baselines"/>-->
        <!--         <fact.io.CreateNestedListFile DataOutputKey="OpenPulseSizesSlope" urlString="file:///net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/kgray/data/test/file-slope-open-pulses.txt" /> -->
        <!--         <fact.io.CreateNestedListFile DataOutputKey="ArrivalTimesSlope" urlString="file:///net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/kgray/data/test/file-slope-arrivalTimes.txt" /> -->
        <!--         <fact.io.CreateNestedListFile DataOutputKey="ArrivalTimesAmp" urlString="file:///net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/kgray/data/test/file-amp-arrivalTimes.txt" /> -->
        <!--         <fact.io.CreateNestedListFile DataOutputKey="ClosedPulseSizesAmp" urlString="file:///net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/kgray/data/test/file-amp-closed-pulses.txt" /> -->
        <!--<fact.ShowViewer key="DataCalibrated" />-->
        <PrintData/>
    </process>

    <!-- Pathes to the input files -->
</container>
