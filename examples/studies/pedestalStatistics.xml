<container>
    <properties url="classpath:/default/settings.properties" />

    <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
    <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />

    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixelDelayFile" value="classpath:/default/delays_lightpulser_20150217.csv" />

    <property name="outfile" value="./test.json" />

    <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="file:src/main/resources/aux/" />
    <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />

    <stream id="fact" class="fact.io.zfits.ZFitsStream" url="${infile}" />
            <!--limit="5"-->

            
        <process input="fact" >
            <fact.utils.PreviousEventInfo
                    startCellKey="StartCellData"
                    outputKey="prevEvents"
                    limitEvents="10"
            />

            <stream.flow.Skip condition="%{data.EventNum} &lt; 0" />

            <fact.datacorrection.DrsCalibration
                    url="${drsfile}"
                    key="Data"
                    outputKey="DataCalibrated"
            />

            <fact.datacorrection.PatchJumpRemoval
                    dataKey="DataCalibrated"
                    outputKey="DataCalibrated"
                    prevEventsKey="prevEvents"
                    startCellKey="StartCellData"
                    jumpLimit="${patchJumpRemoval_jumpLimit}"
            />

            <fact.datacorrection.RemoveSpikes
                    dataKey="DataCalibrated"
                    outputKey="DataCalibrated"
                    startCellKey="StartCellData"
                    leftBorder="${removeSpikes_leftBorder}"
                    spikeLimit="${removeSpikes_spikeLimit}"
                    topSlopeLimit="${removeSpikes_topSlopeLimit}"
                    maxSpikeLength="${removeSpikes_maxSpikeLength}"
            />

            <fact.filter.DrsTimeCalibration
                    outputKey="timeCalibConst"
            />

            <fact.filter.ArrayTimeCorrection
                    dataKey="DataCalibrated"
                    timeCalibConstKey="timeCalibConst"
                    outputKey="DataCalibrated"
            />

            <fact.datacorrection.InterpolateTimeSeries
                    calibService="calibService"
                    dataKey="DataCalibrated"
                    dataOutputKey="DataCalibrated"
            />

            <fact.extraction.BasicExtraction
            dataKey="DataCalibrated"
            outputKeyMaxAmplPos="maxPos"
            outputKeyPhotonCharge="photoncharge"
            url="${integralGainFile}"
            startSearchWindow="${basicExtraction_startSearchWindow}"
            rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
            rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
            />

            <fact.extraction.EstimateBaseline
                    dataKey="DataCalibrated"
                    outputKey="baseline"
                    firstSlice="10"
                    range="30"
            />

            <fact.extraction.TimeOverThreshold
                    dataKey="DataCalibrated"
                    outputKey="timeOverThreshold"
                    firstSliceOverThresholdOutputKey="arrivalTimeTOT"
                    positionsKey="maxPos"
                    threshold="1800"
                    thresholdOutputKey="thresholdForToT"
            />

            <fact.datacorrection.CorrectSaturation
                    dataKey="DataCalibrated"
                    outputKey="DataCalibrated"
                    totKey="timeOverThreshold"
                    firstSliceOverThresholdKey="arrivalTimeTOT"
                    threshold="1800"
                    maxPosKey="maxPos"
                    baselineKey="baseline"
            />

            <fact.extraction.BasicExtraction
                    dataKey="DataCalibrated"
                    outputKeyMaxAmplPos="maxPos"
                    outputKeyPhotonCharge="photoncharge"
                    url="${integralGainFile}"
                    startSearchWindow="${basicExtraction_startSearchWindow}"
                    rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
                    rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
            />

            <fact.extraction.RisingEdgeForPositions
                    dataKey="DataCalibrated"
                    amplitudePositionsKey="maxPos"
                    outputKey="arrivalTimePos"
                    maxSlopesKey="maxSlopesPos"
            />

            <fact.extraction.RisingEdgePolynomFit
                    dataKey="DataCalibrated"
                    risingEdgeKey="arrivalTimePos"
                    outputKey="arrivalTime"
                    numberOfPoints="11"
                    maxSlopesKey="maxSlopes"
            />

            <fact.datacorrection.CorrectPixelDelays
                    arrivalTimeKey="arrivalTime"
                    outputKey="arrivalTime"
                    url="${pixelDelayFile}"
            />

            <fact.datacorrection.InterpolatePhotondata
                    calibService="calibService"
                    photonChargeKey="photoncharge"
                    photonChargeOutputKey="photoncharge"
                    arrivalTimeKey="arrivalTime"
                    arrivalTimeOutputKey="arrivalTime"
            />

            <fact.pixelsets.Invert
                    insetKey="badPixel"
                    outsetKey="goodPixel"
            />

            <fact.pixelsets.Difference
                    setUKey="goodPixel"
                    setAKey="shower"
                    outsetKey="pedestal"
            />

            <fact.extraction.WaveformFluctuation
                    key="DataCalibrated"
                    outputKey="ped"
                    skipFirst="25"
                    skipLast="50"
                    windowSize="30"
            />

            <fact.statistics.ArrayStatistics
                    key="ped_mean"
                    outputKey="ped_mean"
                    pixelSetKey="pedestal"
            />

            <fact.statistics.ArrayStatistics
                    key="ped_median"
                    outputKey="ped_median"
                    pixelSetKey="pedestal"
            />

            <fact.statistics.ArrayStatistics
                    key="ped_std"
                    outputKey="ped_std"
                    pixelSetKey="pedestal"
            />

            <fact.statistics.ArrayStatistics
                    key="ped_var"
                    outputKey="ped_var"
                    pixelSetKey="pedestal"
            />

            <fact.statistics.ArrayStatistics
                    key="ped_sum"
                    outputKey="ped_sum"
                    pixelSetKey="pedestal"
            />


            <fact.pixelsets.Length
                    pixelSetKey="pedestal"
                    outputKey="numPixelInPedestal"
            />

            <fact.statistics.ArrayStatistics
                    key="photoncharge"
                    outputKey="phChargePedestal"
                    pixelSetKey="pedestal"
            />
            <fact.statistics.ArrayStatistics
                    key="arrivalTime"
                    outputKey="arrTimePedestal"
                    pixelSetKey="pedestal"
            />
            <fact.statistics.ArrayStatistics
                    key="maxSlopes"
                    outputKey="maxSlopesPedestal"
                    pixelSetKey="pedestal"
            />
            <fact.features.Size
                    pixelSetKey="pedestal"
                    photonChargeKey="photoncharge"
                    outputKey="pedestalSize"
            />
            <fact.features.TimeSpread
                    weightsKey="photoncharge"
                    arrivalTimeKey="arrivalTime"
                    pixelSetKey="pedestal"
                    outputKey="pedestalTimespread"
            />

            <fact.filter.GaussConvolution
                    key="DataCalibrated"
                    outputKey="DataSmoothed"
                    variance="5"
            />

            <fact.statistics.TimerowFeatures
                    dataKey="DataCalibrated"
                    movingAverageKey="DataSmoothed"
                    searchWindowLeft="200"
                    searchWindowRight="1000"
                    outputKey="timeRowFeatures"
            />

            <fact.statistics.ArrayStatistics
                    key="timeRowFeatures_mean"
                    outputKey="ped_timeRowFeatures"
                    pixelSetKey="pedestal"
            />

            <fact.statistics.SlidingFastFourierTrafo
                    key="DataCalibrated"
                    outputKey="FFT"
            />

            <fact.filter.GaussConvolution
                    key="FFT"
                    outputKey="FFTsmoothed"
                    variance="5"
            />

            <fact.statistics.TimerowFeatures
                    dataKey="FFT"
                    movingAverageKey="FFTsmoothed"
                    searchWindowLeft="200"
                    searchWindowRight="1000"
                    outputKey="fft_timeRowFeatures"
            />

            <fact.statistics.ArrayStatistics
                    key="fft_timeRowFeatures_mean"
                    outputKey="ped_fft_timeRowFeatures"
                    pixelSetKey="pedestal"
            />


            <PrintData/>

            <!--<fact.utils.SelectArrayByChid-->
                    <!--key="pulseIntegrals"-->
                    <!--chid="0"-->
                    <!--outputKey="pulseIntegrals_1"-->
            <!--/>-->

            <!--<fact.plotter.HistogramArrayPlotter-->
                    <!--key="pulseIntegrals_1"-->
                    <!--binWidth="10"-->
                    <!--logAxis="true"-->
                    <!--color="#667695"-->
            <!--/>-->



            <!--<fact.io.JSONWriter url="file:${outfile}" keys="maxSlopes,arrivalTimes,pulseIntegrals,baselines"/>-->
                <!--<fact.io.JSONWriterExcludeKeys url="file:${outfile}" keys="DataCalibrated,EventNum,TriggerType,NROI,NPIX,Data"/>-->

            <fact.ShowViewer key="DataCalibrated"/>

	</process>
</container>
