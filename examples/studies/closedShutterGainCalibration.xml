<container>

<!-- Closed Shutter Data: -->
    <properties url="classpath:/default/settings.properties" />

    <!-- Pathes to the input files -->
    <!--<property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />-->
    <!--<property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />-->

    <property name="infile" value="file:/home/jbuss/testData/20150901_016.fits.fz" />
    <property name="drsfile" value="file:/home/jbuss/testData/20150901_011.drs.fits.gz" />

    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixelDelayFile" value="classpath:/default/delays_20141114.csv" />


    <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="file:src/main/resources/aux/" />
<!-- Open Shutter Data: -->
<!-- <property name="data" value="/local/data/kgray/test/20130104_095.fits.gz" />  -->
<!-- <property name="dataDRS" value="/local/data/kgray/test/20130104_076.drs.fits.gz" /> -->


    <stream id="fact" class="fact.io.zfits.ZFitsStream" url="${infile}" />
            
        <process id="2" input="fact">
        <fact.utils.PreviousEventInfo
                startCellKey="StartCellData"
                outputKey="prevEvents"
                limitEvents="5"/>

        <stream.flow.Skip condition="%{data.EventNum} &lt; 0" />

        <fact.datacorrection.DrsCalibration
                url="${drsfile}"
                key="Data"
                outputKey="DataCalibrated"
                />
        <fact.datacorrection.PatchJumpRemoval
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                prevEventsKey="prevEvents"
                startCellKey="StartCellData"
                jumpLimit="${patchJumpRemoval_jumpLimit}"
                />
        <fact.datacorrection.RemoveSpikes
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                startCellKey="StartCellData"
                leftBorder="${removeSpikes_leftBorder}"
                spikeLimit="${removeSpikes_spikeLimit}"
                topSlopeLimit="${removeSpikes_topSlopeLimit}"
                maxSpikeLength="${removeSpikes_maxSpikeLength}"
                />
        <fact.filter.DrsTimeCalibration
                outputKey="timeCalibConst"
                />
        <fact.filter.ArrayTimeCorrection
                dataKey="DataCalibrated"
                timeCalibConstKey="timeCalibConst"
                outputKey="DataCalibrated"
                />

        <fact.filter.MovingAverage
                key="DataCalibrated"
                outputKey="DataSmoothed"
                length="3"
                />

<!--  For Closed Shutter Data: Threshold Extraction Method -->

         <fact.features.singlePulse.FindThresholdCrossings
                 key="DataSmoothed"
                 outputKey="StartPositions"
                 visualizeOutputKey="PositionPulseCandidates"
                 minBelow="4"
                 minAbove="9"
                 threshold="5.0"
                 />

         <fact.features.singlePulse.PulseMaxAmplitude
                 key="DataSmoothed"
                 outputKey="PulseMaxAmp"
                 pulsePositionKey="StartPositions"
                 />

         <fact.features.singlePulse.ArrivalTime
                 key="DataSmoothed"
                 outputKey="ArrivalTimesAmp"
                 maxAmpPositionKey="PulseMaxAmp"
                 visualizeKey="halfMaxArrivalTimes"
                 />

         <fact.features.singlePulse.PulseSizeCalculator
                 key="DataSmoothed"
                 outputKey="ClosedPulseSizesAmp"
                 arrivalTimeKey="ArrivalTimesAmp"
                 width="30" />

        <PrintData/>

        <fact.ShowViewer key="DataCalibrated"/>

	</process>
</container>
