<container>

<!-- Closed Shutter Data: -->
    <properties url="classpath:/default/settings.properties" />

    <!-- Pathes to the input files -->
    <!--<property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />-->
    <!--<property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />-->

    <property name="infile" value="file:/local/data/jbuss/Studien/testData/20150901_016.fits.fz" />
    <property name="drsfile" value="file:/local/data/jbuss/Studien/testData/20150901_011.drs.fits.gz" />

    <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
    <property name="pixelDelayFile" value="classpath:/default/delays_20141114.csv" />

    <property name="outfile" value="file:/home/jbuss/testData/20150901_016_singles.json" />

    <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="file:src/main/resources/aux/" />
<!-- Open Shutter Data: -->
<!-- <property name="data" value="/local/data/kgray/test/20130104_095.fits.gz" />  -->
<!-- <property name="dataDRS" value="/local/data/kgray/test/20130104_076.drs.fits.gz" /> -->


    <stream id="fact" class="fact.io.zfits.ZFitsStream" url="${infile}" />
            
        <process id="2" input="fact">
        <fact.utils.PreviousEventInfo
                startCellKey="StartCellData"
                outputKey="prevEvents"
                limitEvents="5"/>

        <stream.flow.Skip condition="%{data.EventNum} &lt; 0" />

        <fact.datacorrection.DrsCalibration
                url="${drsfile}"
                key="Data"
                outputKey="DataCalibrated"
                />
        <fact.datacorrection.PatchJumpRemoval
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                prevEventsKey="prevEvents"
                startCellKey="StartCellData"
                jumpLimit="${patchJumpRemoval_jumpLimit}"
                />
        <fact.datacorrection.RemoveSpikes
                dataKey="DataCalibrated"
                outputKey="DataCalibrated"
                startCellKey="StartCellData"
                leftBorder="${removeSpikes_leftBorder}"
                spikeLimit="${removeSpikes_spikeLimit}"
                topSlopeLimit="${removeSpikes_topSlopeLimit}"
                maxSpikeLength="${removeSpikes_maxSpikeLength}"
                />
        <fact.filter.DrsTimeCalibration
                outputKey="timeCalibConst"
                />
        <fact.filter.ArrayTimeCorrection
                dataKey="DataCalibrated"
                timeCalibConstKey="timeCalibConst"
                outputKey="DataCalibrated"
                />

        <fact.filter.MovingAverage
                key="DataCalibrated"
                outputKey="DataSmoothed"
                length="10"
                />

<!--  For Closed Shutter Data: Threshold Extraction Method -->

         <fact.features.singlePulse.FindThresholdCrossings
                 key="DataSmoothed"
                 outputKey="thresholdCrossings"
                 visualizeOutputKey="thresholdCrossingsVis"
                 minBelow="4"
                 minAbove="9"
                 threshold="5.0"
                 />

         <fact.features.singlePulse.PulseMaxAmplitude
                 key="DataSmoothed"
                 outputKey="maxPositions"
                 pulsePositionKey="thresholdCrossings"
                 />

         <fact.features.singlePulse.ArrivalTime
                 key="DataSmoothed"
                 outputKey="ArrivalTimes"
                 maxAmpPositionKey="maxPositions"
                 visualizeKey="halfMaxVis"
                 />

         <fact.features.singlePulse.PulseSizeCalculator
                 key="DataSmoothed"
                 outputKey="IntegratedCharges"
                 arrivalTimeKey="ArrivalTimes"
                 width="30"
                 />

        <!--<PrintData/>-->

        <fact.utils.SelectArrayByChid
                key="IntegratedCharges"
                chid="55"
                outputKey="IntegratedChargePix55"
                />


        <fact.utils.FillPixelHistogramm
            key="IntegratedCharges"
            outputKey="IntegratedChargesHist"
            numEventsKey="numSingles"
            binWidth="10"
            min="150"
            />
        <stream.flow.Every n="250">

            <fact.features.singlePulse.FitSpectra
                    key="IntegratedChargesHist"
                    outputKey="FitParamters"
                    startValuesKey="startValues"
                    />

            <!--color="#666699"-->
            <fact.io.JSONWriter
                    url="File:/local/data/jbuss/Studien/singlePe2.json"
                    keys="chargesHistogram,IntegratedChargesHist,FitParamters,startValues"
                    />

            <PrintData/>
        </stream.flow.Every>

        <fact.io.JSONWriter
                url="File:/local/data/jbuss/Studien/singlePe2Extr.json"
                keys="IntegratedCharges"
                />

        <!--<fact.ShowViewer key="DataCalibrated"/>-->
        <!--<fact.io.JSONWriter-->
                <!--url="${outfile}"-->
                <!--keys="IntegratedCharges,ArrivalTimes"/>-->

	</process>
</container>
