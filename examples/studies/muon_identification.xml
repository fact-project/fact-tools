<container>

  <properties url="classpath:/default/settings.properties" />

  <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
  <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />

  <property name="integral_gain_file" value="classpath:/default/gain_sorted_20131127.csv" />
  <property name="pixel_delay_file" value="classpath:/default/delays_lightpulser_20150217.csv" />
  <property name="auxpath" value="file:src/main/resources/aux/" />

  <service id="aux_service" class="fact.auxservice.AuxFileService" auxFolder="${auxpath}" />
  <service id="calib_service" class="fact.calibrationservice.ConstantCalibService" />

  <property name="outfile" value="facttools.json" />

  <property name="twoLevelTimeNeighbor_coreThreshold" value="4.0" />
  <property name="twoLevelTimeNeighbor_neighborThreshold" value="2.0" />
  <property name="twoLevelTimeNeighbor_timeLimit" value="3.0" />
  <property name="twoLevelTimeNeighbor_minNumberOfPixel" value="2" />

  <property name="features" value="timestamp,cog_x,cog_y,conc_core,delta,EventNum,leakage,leakage2,length,m3_long,m3_trans,m4_long,m4_trans,NIGHT,NumPixelAfterCleaning,PCOUNT,RUNID,RUNTYPE,size,width,arrival_time_cleaning_statistics_kurtosis,arrival_time_cleaning_statistics_max,arrival_time_cleaning_statistics_mean,arrival_time_cleaning_statistics_min,arrival_time_cleaning_statistics_skewness,arrival_time_cleaning_statistics_variance,arrival_time_statistics_kurtosis,arrival_time_statistics_max,arrival_time_statistics_mean,arrival_time_statistics_min,arrival_time_statistics_skewness,arrival_time_statistics_variance,best_r,best_ring_pixel,best_x,best_y,shower,conc1,conc2,conc_cog,hough_cleaning_percentage,hough_distance,hough_octants_hit,hough_peakness,hough_ring_percentage,numIslands,photoncharge_cleaning_statistics_kurtosis,photoncharge_cleaning_statistics_max,photoncharge_cleaning_statistics_mean,photoncharge_cleaning_statistics_min,photoncharge_cleaning_statistics_skewness,photoncharge_cleaning_statistics_variance,photoncharge_statistics_kurtosis,photoncharge_statistics_max,photoncharge_statistics_mean,photoncharge_statistics_min,photoncharge_statistics_skewness,photoncharge_statistics_variance,time_over_threshold_num_pixel,ZdPointing,ZdTracking,ZdSourceCalc,distance,SourceName,gaussianFitX,gaussianFitY,gaussianFitR,gaussianFitSigma,StdDevTime8.0,numPixelStdDevTime8.0"/>

  <property name="outputKeys" value="${features}"/>

  <stream id="fact" class="fact.io.zfits.ZFitsStream"  url="${infile}" />

  <process id="2" input="fact">

    <fact.features.UnixTimeUTC2DateTime />

    <fact.utils.PreviousEventInfo
            startCellKey="StartCellData"
            outputKey="prev_events"
            limitEvents="${prev_events_limit_events}"
    />
    <stream.flow.Skip condition="%{data.TriggerType} != 4" />

    <fact.datacorrection.DrsCalibration
            url="${drsfile}"
            key="Data"
            outputKey="data_calibrated"
    />
    <fact.datacorrection.PatchJumpRemoval
            dataKey="data_calibrated"
            outputKey="data_calibrated"
            prevEventsKey="prev_events"
            startCellKey="StartCellData"
            jumpLimit="${patch_jump_removal_jump_limit}"
    />
    <fact.datacorrection.RemoveSpikes
            dataKey="data_calibrated"
            outputKey="data_calibrated"
            startCellKey="StartCellData"
            leftBorder="${remove_spikes_left_border}"
            spikeLimit="${remove_spikes_spike_limit}"
            topSlopeLimit="${remove_spikes_top_slope_limit}"
            maxSpikeLength="${remove_spikes_max_spike_length}"
    />
    <fact.filter.DrsTimeCalibration
            outputKey="time_calib_const"
    />
    <fact.filter.ArrayTimeCorrection
            dataKey="data_calibrated"
            timeCalibConstKey="time_calib_const"
            outputKey="data_calibrated"
    />
    <fact.datacorrection.InterpolateTimeSeries
            calibService="calib_service"
            dataKey="data_calibrated"
            dataOutputKey="data_calibrated"
    />

    <fact.extraction.BasicExtraction
            dataKey="data_calibrated"
            outputKeyMaxAmplPos="max_pos"
            outputKeyPhotonCharge="photoncharge"
            url="${integral_gain_file}"
            startSearchWindow="${basic_extraction_start_search_window}"
            rangeSearchWindow="${basic_extraction_range_search_window}"
            rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
    />
    <fact.extraction.EstimateBaseline
            dataKey="data_calibrated"
            outputKey="baseline"
            firstSlice="10"
            range="30"
    />
    <fact.extraction.TimeOverThreshold
            dataKey="data_calibrated"
            outputKey="time_over_threshold"
            firstSliceOverThresholdOutputKey="arrival_time_tot"
            positionsKey="max_pos"
            threshold="1800"
            thresholdOutputKey="threshold_for_tot"
    />
    <fact.datacorrection.CorrectSaturation
            dataKey="data_calibrated"
            outputKey="data_calibrated"
            totKey="time_over_threshold"
            firstSliceOverThresholdKey="arrival_time_tot"
            threshold="1800"
            maxPosKey="max_pos"
            baselineKey="baseline"
    />
    <fact.extraction.BasicExtraction
            dataKey="data_calibrated"
            outputKeyMaxAmplPos="max_pos"
            outputKeyPhotonCharge="photoncharge"
            url="${integral_gain_file}"
            startSearchWindow="${basic_extraction_start_search_window}"
            rangeSearchWindow="${basic_extraction_range_search_window}"
            rangeHalfHeightWindow="${basic_extraction_range_half_heigth_window}"
    />
    <fact.extraction.RisingEdgeForPositions
            dataKey="data_calibrated"
            amplitudePositionsKey="max_pos"
            outputKey="arrival_time_pos"
            maxSlopesKey="max_slopes_pos"
    />
    <fact.extraction.RisingEdgePolynomFit
            dataKey="data_calibrated"
            risingEdgeKey="arrival_time_pos"
            outputKey="arrival_time"
            numberOfPoints="11"
            maxSlopesKey="max_slopes"
    />
    <fact.datacorrection.CorrectPixelDelays
            arrivalTimeKey="arrival_time"
            outputKey="arrival_time"
            url="${pixel_delay_file}"
    />
    <fact.datacorrection.InterpolatePhotondata
            calibService="calib_service"
            photonChargeKey="photoncharge"
            photonChargeOutputKey="photoncharge"
            arrivalTimeKey="arrival_time"
            arrivalTimeOutputKey="arrival_time"
    />

    <fact.features.source.SourcePosition
            outputKey="cetatauri"
            sourceRightAscension="5.627416667"
            sourceDeclination="21.1425"
            auxService="aux_service"
    />

    <fact.cleaning.TwoLevelTimeNeighbor
            calibService="calib_service"
            photonChargeKey="photoncharge"
            outputKey="shower"
            arrivalTimeKey="arrival_time"
            corePixelThreshold="${two_level_time_neighbor_core_threshold}"
            neighborPixelThreshold="${two_level_time_neighbor_neighbor_threshold}"
            timeLimit="${two_level_time_neighbor_time_limit}"
            minNumberOfPixel="${two_level_time_neighbor_min_number_of_pixel}"
            starPositionKeys="cetatauri"
            starRadiusInCamera="11.0"
    />


    <Skip condition="%{data.shower} == null" />
    <fact.pixelsets.Length pixelSetKey="shower" outputKey="NumPixelAfterCleaning" />
    <Skip condition="%{data.NumPixelAfterCleaning} &lt; 15" />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="photoncharge_statistics"
    />
    <fact.statistics.ArrayStatistics
            key="arrival_time"
            outputKey="arrival_time_statistics"
    />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="photoncharge_cleaning_statistics"
            pixelSetKey="shower"
    />
    <fact.statistics.ArrayStatistics
            key="arrival_time"
            outputKey="arrival_time_cleaning_statistics"
            pixelSetKey="shower"
    />

    <fact.features.HillasParameter
            weightsKey="photoncharge"
            pixelSetKey="shower"
            outputKey="shower_distribution"
            m3longKey="m3_long"
            m3transKey="m3_trans"
            m4longKey="m4_long"
            m4transKey="m4_trans"
            cogxKey="cog_x"
            cogyKey="cog_y"
            lengthKey="length"
            widthKey="width"
            deltaKey="delta"
            sizeKey="size"
            c0="117.94"
            dispKey="disp"
    />

    <fact.features.TimeGradient
            pixelSetKey="shower"
            arrivalTimeKey="arrival_time"
            cogxKey="cog_y"
            cogyKey="cog_y"
            deltaKey="delta"
            outputKeySlope="time_gradient_slope"
            outputKeyIntercept="time_gradient_intercept"
            outputKeySumSquaredErrors="time_gradient_sse"
    />
    <fact.features.Concentration
            weights="photoncharge"
            pixelSetKey="shower"
            concOneOutputKey="conc1"
            concTwoOutputKey="conc2"
    />
    <fact.features.ConcentrationCore
            cogxKey="cog_x"
            cogyKey="cog_y"
            pixelSetKey="shower"
            photonChargeKey="photoncharge"
            sizeKey="size"
            widthKey="width"
            lengthKey="length"
            deltaKey="delta"
            outputKey="conc_core"
    />
    <fact.features.ConcentrationAtCenterOfGravity
            photonChargeKey="photoncharge"
            cogxKey="cog_x"
            cogyKey="cog_y"
            sizeKey="size"
            outputKey="conc_cog"
    />
    <fact.features.Leakage
            distribution="shower_distribution"
            pixelSetKey="shower"
            weights="photoncharge"
            leakage1OutputKey="leakage"
            leakage2OutputKey="leakage2"
    />

    <fact.features.muon.HoughTransform
            showRingKey="false"
            showMatrixKey="false"
            photonChargeKey="photoncharge"
            bestCircleKey="best_ring"
            pixelSetKey="shower"
            peaknessKey="hough_peakness"
            cleaningPercentageKey="hough_cleaning_percentage"
            ringPercentageKey="hough_ring_percentage"
            distanceKey="hough_distance"
            octantsHitKey="hough_octants_hit"
            bestRingPixelKey="best_ring_pixel"
            bestRadiusKey="best_r"
            bestXKey="best_x"
            bestYKey="best_y"
    />

    <fact.features.source.SourcePosition
            outputKey="source_position"
            auxService="aux_service"
    />

    <fact.features.source.Distance
            distribution="shower_distribution"
            sourcePosition="source_position"
            outputKey="distance"
    />

    <fact.features.muon.CircularFit />
    <fact.features.muon.GaussianFit
            startXKey="circ_fit_x"
            startYKey="circ_fit_y"
            startRKey="circ_fit_r"
    />

    <fact.features.muon.RingStandardDeviationWithThreshold threshold="8" />

    <!--<fact.io.JSONWriter  url="file:${outfile}" keys="${outputKeys}" />-->
    <!-- <fact.ShowViewer key="DataCalibrated"/> -->
  </process>
</container>
