<container>

	<!--  Event 64 should be a muon ring -->
	<property name="data" value="/home/max_noethe/phido/fhgfs/groups/app/fact/raw/2013/02/05/20130205_060.fits.gz" /> 
	<property name="drsfile" value="/home/max_noethe/phido/fhgfs/groups/app/fact/raw/2013/02/05/20130205_053.drs.fits.gz" />
	
	<property name="outfile" value="/home/max_noethe/fact-daten/test/test.json" />
	
    <stream id="fact" class="fact.io.zfits.ZFitsStream"  url="file:${data}"/>
	<process input="fact">
		
    	
    	<fact.utils.PreviousEventInfo startCellKey="StartCellData" outputKey="prevEvents" limitEvents="10"/>
		<stream.flow.Skip condition="%{data.TriggerType} != 4" />
		
		
		<fact.io.zfits.ZFitsDrsCalib optional="true" url="file:${data}" outputKey="DataZCal" />
    	<fact.datacorrection.DrsCalibration url="file:${drsfile}" key="DataZCal"  outputKey="DataCalibrated" color="#000000"/>
        
<!--         <fact.datacorrection.DrsCalibration url="file:${drsfile}" key="Data"  outputKey="DataCalibrated" color="#000000"/>   -->
        
        <fact.datacorrection.PatchJumpRemoval dataKey="DataCalibrated"
        									  outputKey="DataCalibrated"
        									  color="#E6172F"
        									  outputJumpsKey="j"
        									  prevEventsKey="prevEvents"
        									  startCellKey="StartCellData"
        									  jumpLimit="2.0" />
        
        <fact.datacorrection.RemoveSpikes dataKey="DataCalibrated"
        								  outputKey="DataCalibrated"
        								  startCellKey="StartCellData"
        								  leftBorder="6" spikeLimit="20"
        								  topSlopeLimit="16"
        								  maxSpikeLength="4"
        								  outputSpikesKey="Sp"
        								  color="#000000" />
        
        <fact.datacorrection.InterpolateBadPixel key="DataCalibrated"
        										 outputKey="DataCalibrated"
                								 badChidIds="863,868,297,927,80,873,1093,1094,527,528,721,722" />
       <fact.extraction.BasicExtraction dataKey="DataCalibrated" 
							        	outputKeyMaxAmplPos="maxAmplitudePosition"
							        	outputKeyPhotonCharge="photoncharge" 
							        	url="file:src/main/resources/gain_sorted_20131127.csv"
							        	startSearchWindow="35"
							        	rangeSearchWindow="90"
							        	rangeHalfHeightWindow="25"
        />
        									  
        <fact.extraction.RisingEdgeForPositions dataKey="DataCalibrated" 
        										amplitudePositionsKey="maxAmplitudePosition" 
        										outputKey="arrivalTime"/>
        
         
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photonCharge" 
        								 outputKey="cleanPixel"
        								 arrivalTimeKey="arrivalTime"
           								 corePixelThreshold="4.0"
           								 neighborPixelThreshold="2.0"
           								 timeThreshold="15"
           								 minNumberOfPixel="2" 
           								 showDifferentCleaningSets="false"/>
        

            <Skip condition="%{data.cleanPixel}==null"/>
			<fact.features.NumberOfPixelInShower showerKey="cleanPixel" outputKey="numPixelInCleanPixel" />
			<Skip condition="%{data.numPixelInCleanPixel} &lt; 15" />
			
			<fact.features.Leakage shower="cleanPixel" weights="photonCharge" leakage1OutputKey="Leakage" leakage2OutputKey="Leakage2" />
			<Skip condition="%{data.Leakage} &gt; 0.1" />
			
			
			<fact.features.MuonHoughTransform showRingKey="false"  
											  showMatrixKey="false"
											  photonChargeKey="photonCharge"
											  peaknessKey="houghPeakness"
											  bestCircleKey="bestRing"
											  pixelKey="cleanPixel" 
											  cleaningPercentageKey="houghCleaningPercentage"
											  ringPercentageKey="houghRingPercentage"
											  distanceKey="houghDistance"
			                                  octantsHitKey="octantsHit"
			                                  bestRingPixelKey="bestRingPixel"
			                                  bestRadiusKey="bestR" 
			                                  bestXKey="bestX"
			                                  bestYKey="bestY" />
			
			<fact.io.PrintKeysOnConsole keys="EventNum,houghPeakness,houghDistance,houghCleaningPercentage,houghRingPercentage,octantsHit"/>
			
<!-- 			Cuts: -->											  
			<Skip condition="%{data.houghDistance} &gt; 100" />
			<Skip condition="%{data.houghPeakness} &lt; 7" />
			<Skip condition="%{data.houghCleaningPercentage} &lt; 0.7" />
<!-- 			<Skip condition="%{data.houghRingPercentage} &lt; 0.22" /> -->
			<Skip condition="%{data.octantsHit} &lt; 5" />

			
<!-- 			<fact.ShowViewer key="photonCharge" range="25,250"/>  -->
			<fact.io.JSONWriter url="file:${outfile}" keys="houghPeakness,houghDistance,houghCleaningPercentage,houghRingPercentage,octantsHit,bestR,bestX,bestY,NIGHT,RUNID,EventNum,photonCharge,arrivalTime,bestRingPixel" />
		</process>
</container>
