<container>

  <properties url="classpath:/default/settings.properties" />

  <property name="infile" value="file:src/main/resources/testDataFile.fits.gz" />
  <property name="drsfile" value="file:src/main/resources/testDrsFile.drs.fits.gz" />

  <property name="integralGainFile" value="classpath:/default/gain_sorted_20131127.csv" />
  <property name="pixelDelayFile" value="classpath:/default/delays_lightpulser_20150217.csv" />
  <property name="auxpath" value="file:src/main/resources/aux/" />

  <service id="auxService" class="fact.auxservice.AuxFileService" auxFolder="${auxpath}" />
  <service id="calibService" class="fact.calibrationservice.ConstantCalibService" />

  <property name="outfile" value="facttools.json" />

  <property name="twoLevelTimeNeighbor_coreThreshold" value="4.0" />
  <property name="twoLevelTimeNeighbor_neighborThreshold" value="2.0" />
  <property name="twoLevelTimeNeighbor_timeLimit" value="3.0" />
  <property name="twoLevelTimeNeighbor_minNumberOfPixel" value="2" />

  <property name="features" value="timestamp,COGx,COGy,ConcCore,Delta,EventNum,Leakage,Leakage2,Length,M3Long,M3Trans,M4Long,M4Trans,NIGHT,NumPixelAfterCleaning,PCOUNT,RUNID,RUNTYPE,Size,Width,arrivalTimeCleaningStatistics_kurtosis,arrivalTimeCleaningStatistics_max,arrivalTimeCleaningStatistics_mean,arrivalTimeCleaningStatistics_min,arrivalTimeCleaningStatistics_skewness,arrivalTimeCleaningStatistics_variance,arrivalTimeStatistics_kurtosis,arrivalTimeStatistics_max,arrivalTimeStatistics_mean,arrivalTimeStatistics_min,arrivalTimeStatistics_skewness,arrivalTimeStatistics_variance,bestR,bestRingPixel,bestX,bestY,shower,conc1,conc2,concCOG,houghCleaningPercentage,houghDistance,houghOctantsHit,houghPeakness,houghRingPercentage,numIslands,photonchargeCleaningStatistics_kurtosis,photonchargeCleaningStatistics_max,photonchargeCleaningStatistics_mean,photonchargeCleaningStatistics_min,photonchargeCleaningStatistics_skewness,photonchargeCleaningStatistics_variance,photonchargeStatistics_kurtosis,photonchargeStatistics_max,photonchargeStatistics_mean,photonchargeStatistics_min,photonchargeStatistics_skewness,photonchargeStatistics_variance,timeOverThreshold_numPixel,ZdPointing,ZdTracking,ZdSourceCalc,Distance,SourceName,gaussianFitX,gaussianFitY,gaussianFitR,gaussianFitSigma,StdDevTime8.0,numPixelStdDevTime8.0"/>

  <property name="outputKeys" value="${features}"/>

  <stream id="fact" class="fact.io.zfits.ZFitsStream"  url="${infile}" />

  <process id="2" input="fact">

    <fact.features.UnixTimeUTC2DateTime />

    <fact.utils.PreviousEventInfo
            startCellKey="StartCellData"
            outputKey="prevEvents"
            limitEvents="${prevEvents_limitEvents}"
    />
    <stream.flow.Skip condition="%{data.TriggerType} != 4" />

    <fact.datacorrection.DrsCalibration
            url="${drsfile}"
            key="Data"
            outputKey="DataCalibrated"
    />
    <fact.datacorrection.PatchJumpRemoval
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            prevEventsKey="prevEvents"
            startCellKey="StartCellData"
            jumpLimit="${patchJumpRemoval_jumpLimit}"
    />
    <fact.datacorrection.RemoveSpikes
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            startCellKey="StartCellData"
            leftBorder="${removeSpikes_leftBorder}"
            spikeLimit="${removeSpikes_spikeLimit}"
            topSlopeLimit="${removeSpikes_topSlopeLimit}"
            maxSpikeLength="${removeSpikes_maxSpikeLength}"
    />
    <fact.filter.DrsTimeCalibration
            outputKey="timeCalibConst"
    />
    <fact.filter.ArrayTimeCorrection
            dataKey="DataCalibrated"
            timeCalibConstKey="timeCalibConst"
            outputKey="DataCalibrated"
    />
    <fact.datacorrection.InterpolateTimeSeries
            calibService="calibService"
            dataKey="DataCalibrated"
            dataOutputKey="DataCalibrated"
    />

    <fact.extraction.BasicExtraction
            dataKey="DataCalibrated"
            outputKeyMaxAmplPos="maxPos"
            outputKeyPhotonCharge="photoncharge"
            url="${integralGainFile}"
            startSearchWindow="${basicExtraction_startSearchWindow}"
            rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
            rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
    />
    <fact.extraction.EstimateBaseline
            dataKey="DataCalibrated"
            outputKey="baseline"
            firstSlice="10"
            range="30"
    />
    <fact.extraction.TimeOverThreshold
            dataKey="DataCalibrated"
            outputKey="timeOverThreshold"
            firstSliceOverThresholdOutputKey="arrivalTimeTOT"
            positionsKey="maxPos"
            threshold="1800"
            thresholdOutputKey="thresholdForToT"
    />
    <fact.datacorrection.CorrectSaturation
            dataKey="DataCalibrated"
            outputKey="DataCalibrated"
            totKey="timeOverThreshold"
            firstSliceOverThresholdKey="arrivalTimeTOT"
            threshold="1800"
            maxPosKey="maxPos"
            baselineKey="baseline"
    />
    <fact.extraction.BasicExtraction
            dataKey="DataCalibrated"
            outputKeyMaxAmplPos="maxPos"
            outputKeyPhotonCharge="photoncharge"
            url="${integralGainFile}"
            startSearchWindow="${basicExtraction_startSearchWindow}"
            rangeSearchWindow="${basicExtraction_rangeSearchWindow}"
            rangeHalfHeightWindow="${basicExtraction_rangeHalfHeigthWindow}"
    />
    <fact.extraction.RisingEdgeForPositions
            dataKey="DataCalibrated"
            amplitudePositionsKey="maxPos"
            outputKey="arrivalTimePos"
            maxSlopesKey="maxSlopesPos"
    />
    <fact.extraction.RisingEdgePolynomFit
            dataKey="DataCalibrated"
            risingEdgeKey="arrivalTimePos"
            outputKey="arrivalTime"
            numberOfPoints="11"
            maxSlopesKey="maxSlopes"
    />
    <fact.datacorrection.CorrectPixelDelays
            arrivalTimeKey="arrivalTime"
            outputKey="arrivalTime"
            url="${pixelDelayFile}"
    />
    <fact.datacorrection.InterpolatePhotondata
            calibService="calibService"
            photonChargeKey="photoncharge"
            photonChargeOutputKey="photoncharge"
            arrivalTimeKey="arrivalTime"
            arrivalTimeOutputKey="arrivalTime"
    />

    <fact.features.source.SourcePosition
            outputKey="Cetatauri"
            sourceRightAscension="5.627416667"
            sourceDeclination="21.1425"
            auxService="auxService"
    />

    <fact.cleaning.TwoLevelTimeNeighbor
            calibService="calibService"
            photonChargeKey="photoncharge"
            outputKey="shower"
            arrivalTimeKey="arrivalTime"
            corePixelThreshold="${twoLevelTimeNeighbor_coreThreshold}"
            neighborPixelThreshold="${twoLevelTimeNeighbor_neighborThreshold}"
            timeLimit="${twoLevelTimeNeighbor_timeLimit}"
            minNumberOfPixel="${twoLevelTimeNeighbor_minNumberOfPixel}"
            starPositionKeys="Cetatauri"
            starRadiusInCamera="11.0"
    />


    <Skip condition="%{data.shower} == null" />
    <fact.pixelsets.Length pixelSetKey="shower" outputKey="NumPixelAfterCleaning" />
    <Skip condition="%{data.NumPixelAfterCleaning} &lt; 15" />

    <fact.features.DistributionFromShower
            weightsKey="photoncharge"
            pixelSetKey="shower"
            outputKey="showerDistribution"
            m3longKey="M3Long"
            m3transKey="M3Trans"
            m4longKey="M4Long"
            m4transKey="M4Trans"
            cogxKey="COGx"
            cogyKey="COGy"
            lengthKey="Length"
            widthKey="Width"
            deltaKey="Delta"
            numIslandsKey = "numIslands"
            sizeKey="Size"
            c0="117.94"
            dispKey="Disp"
    />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="photonchargeStatistics"
    />
    <fact.statistics.ArrayStatistics
            key="arrivalTime"
            outputKey="arrivalTimeStatistics"
    />

    <fact.statistics.ArrayStatistics
            key="photoncharge"
            outputKey="photonchargeCleaningStatistics"
            pixelSetKey="shower"
    />
    <fact.statistics.ArrayStatistics
            key="arrivalTime"
            outputKey="arrivalTimeCleaningStatistics"
            pixelSetKey="shower"
    />

    <fact.features.Concentration
            weights="photoncharge"
            pixelSetKey="shower"
            concOneOutputKey="conc1"
            concTwoOutputKey="conc2"
    />

    <fact.features.ConcentrationCore
            cogxKey="COGx"
            cogyKey="COGy"
            pixelSetKey="shower"
            photonChargeKey="photoncharge"
            sizeKey="Size"
            widthKey="Width"
            lengthKey="Length"
            deltaKey="Delta"
            outputKey="ConcCore"
    />
    <fact.features.ConcentrationAtCenterOfGravity
            photonChargeKey="photoncharge"
            cogxKey="COGx"
            cogyKey="COGy"
            sizeKey="Size"
            outputKey="concCOG"
    />
    <fact.features.Leakage
            distribution="showerDistribution"
            pixelSetKey="shower"
            weights="photoncharge"
            leakage1OutputKey="Leakage"
            leakage2OutputKey="Leakage2"
    />

    <fact.features.muon.HoughTransform
            showRingKey="false"
            showMatrixKey="false"
            photonChargeKey="photoncharge"
            bestCircleKey="bestRing"
            pixelSetKey="shower"
            peaknessKey="houghPeakness"
            cleaningPercentageKey="houghCleaningPercentage"
            ringPercentageKey="houghRingPercentage"
            distanceKey="houghDistance"
            octantsHitKey="houghOctantsHit"
            bestRingPixelKey="bestRingPixel"
            bestRadiusKey="bestR"
            bestXKey="bestX"
            bestYKey="bestY"
    />

    <fact.features.source.SourcePosition
            outputKey="sourcePosition"
            auxService="auxService"
    />

    <fact.features.source.Distance
            distribution="showerDistribution"
            sourcePosition="sourcePosition"
            outputKey="Distance"
    />

    <fact.features.muon.CircularFit />
    <fact.features.muon.GaussianFit
            startXKey="circFitX"
            startYKey="circFitY"
            startRKey="circFitR"
    />

    <fact.features.muon.RingStandardDeviationWithThreshold threshold="8" />

    <!--<fact.io.JSONWriter  url="file:${outfile}" keys="${outputKeys}" />-->
    <!-- <fact.ShowViewer key="DataCalibrated"/> -->
  </process>
</container>