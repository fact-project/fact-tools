<container>

	<property name="fhgfs" value="/net/home.e5.physik.tu-dortmund.de/vol/ph_e5v/e5b/homes/jbuss/e5/fhgfs" />
	<!-- <property name="fhgfs" value="/fhgfs/groups/app" /> -->

	<!-- Pathes to the input files -->
	<property name="infile" value="${fhgfs}/users/jbuss/analysis/saturationStudy/20150128_manyPhotons/00000001.001_D_MonteCarlo000_Events.fits" />
	<property name="drsfile" value="${fhgfs}/groups/app/fact/simulated/drsfiles/12bitADC/offsetMinus1850/test300samples.drs.fits.gz" />
	<property name="outfile" 	value="${fhgfs}/users/jbuss/analysis/saturationStudy/20150128_manyPhotons/00000001.001_D_MonteCarlo000_Events.json" />

	<property name="integralGainFile" value="src/main/resources/defaultIntegralGains.csv" />

	<property name="time_limit" value="10.0" />
	<property name="min_number_of_pixel" value="2" />
	<property name="start_search_window" value="35" />
	<property name="range_search_window" value="60" />
	<property name="extractionTreshold" 	value="10" />


	<!-- Name of the stream and url to the input file -->
	<stream id="fact" class="fact.io.FitsStream"  url="file:${infile}"/>

	<!-- Description of the process and the corresponding stream -->
	<process id="2" input="fact">
		<stream.flow.Skip condition="%{data.EventNum} &lt; 0" />
		<fact.utils.Remapping key="Data" outputKey="Data"/>
		<fact.utils.RemappingKeys keys="McCherPhotWeight,McCherPhotNumber,McMuonCherPhotWeight,McNoisePhotWeight,McCherArrTimeMean,McCherArrTimeVar,McCherArrTimeMin,McCherArrTimeMax" />

		<fact.filter.DrsCalibration
				url="file:${drsfile}"
				key="Data"
				outputKey="DataCalibrated"
				/>
		<fact.datacorrection.RemoveSpikes
				dataKey="DataCalibrated"
				outputKey="DataCalibrated"
				startCellKey="StartCellData"
				leftBorder="6"
				spikeLimit="20"
				topSlopeLimit="16"
				maxSpikeLength="4"
				/>
		<!--<fact.datacorrection.InterpolateBadPixel-->
				<!--key="DataCalibrated"-->
				<!--outputKey="DataCalibrated"-->
				<!--badChidIds="863,868,297,927,80,873,1093,1094,527,528,721,722"-->
				<!--/>-->

		<stream.flow.Skip condition="%{data.TriggerType} != 4" />

		<fact.extraction.BasicExtraction
				dataKey="DataCalibrated"
				outputKeyMaxAmplPos="maxPos"
				outputKeyPhotonCharge="photoncharge"
				url="file:${integralGainFile}"
				startSearchWindow="${start_search_window}"
				rangeSearchWindow="${range_search_window}"
				rangeHalfHeightWindow="25"
				/>

		<fact.extraction.EstimateBaseline
				dataKey="DataCalibrated"
				outputKey="baseline"
				firstSlice="10"
				range="40"
				/>

		<fact.extraction.RisingEdgeForPositions
				dataKey="DataCalibrated"
				amplitudePositionsKey="maxPos"
				outputKey="arrivalTimePos"
				maxSlopesKey="maxSlopesPos"
				/>
		<fact.extraction.RisingEdgePolynomFit
				dataKey="DataCalibrated"
				risingEdgeKey="arrivalTimePos"
				outputKey="arrivalTime"
				numberOfPoints="11"
				maxSlopesKey="maxSlopes"
				/>
		<fact.extraction.TimeOverThreshold
				dataKey="DataCalibrated"
				outputKey="timeOverThreshold"
				firstSliceOverThresholdOutputKey="arrivalTimeTOT"
				positionsKey="maxPos"
				threshold="1800"
				thresholdOutputKey="thresholdForToT"
				/>

		<fact.extraction.TimeOverThreshold
				dataKey="DataCalibrated"
				outputKey="timeOverThreshold1000"
				firstSliceOverThresholdOutputKey="arrivalTimeTOT1000"
				positionsKey="maxPos"
				threshold="1000"
				thresholdOutputKey="thresholdForToT1000"
				/>

		<fact.datacorrection.CorrectSaturation
				dataKey="DataCalibrated"
				outputKey="DataNoSat"
				totKey="timeOverThreshold"
				firstSliceOverThresholdKey="arrivalTimeTOT"
				threshold="1800"
				maxPosKey="maxPos"
				baselineKey="baseline"
				/>

		<fact.extraction.BasicExtraction
				dataKey="DataNoSat"
				outputKeyMaxAmplPos="maxPosNoSat"
				outputKeyPhotonCharge="phChargeNoSat"
				url="file:${integralGainFile}"
				startSearchWindow="${start_search_window}"
				rangeSearchWindow="${range_search_window}"
				rangeHalfHeightWindow="25"
				/>

		<fact.extraction.PhotonChargeTimeOverThreshold
				timeOverThresholdKey="timeOverThreshold"
				thresholdKey="thresholdForToT"
				outputKey="photonchargeSaturated"
				/>

		<fact.extraction.PhotonChargeTimeOverThreshold
				timeOverThresholdKey="timeOverThreshold1000"
				thresholdKey="thresholdForToT1000"
				outputKey="photonchargeSaturated1000"
				/>

		<fact.extraction.IdentifyPixelAboveThreshold
				key="photoncharge"
				threshold="200"
				outputKey="pixelAbove200Pe" />

		<fact.io.PrintKeysOnConsole keys="MCorsikaEvtHeader.fTotalEnergy" />
		<!-- <stream.flow.Skip condition="%{data.TriggerType} != 1024" /> -->
		<!-- <stream.flow.Skip condition="%{data.EventNum} &lt; 0" /> -->
		<!-- <stream.flow.Skip condition="%{data.TriggerType} != 1024" /> -->
		<!-- <Skip condition="%{data.shower} == null" /> -->

		<PrintData/>
		<!--<fact.ShowViewer key="DataCalibrated"/>-->
			<fact.io.JSONWriter url="file:${outfile}" keys="timeOverThreshold,timeOverThreshold1000,arrivalTimePos,arrivalTime,arrivalTimeTOT,arrivalTimeTOT1000,maxPos,maxSlopesPos,photoncharge,photonchargeSaturated,photonchargeSaturated1000,MCorsikaEvtHeader.fWeightedNumPhotons,McCherPhotWeight,McCherPhotNumber"/>

	</process>

</container>
