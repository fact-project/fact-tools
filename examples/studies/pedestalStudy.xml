<container>

    <!-- Pfade zu den fits files. -->
	<property name="infile" value="/home/fabian/mount/data/LinuxDaten/uni/FACT/Testdata/20141001_275.fits.fz" />
	<property name="drsfile" value="/home/fabian/mount/data/LinuxDaten/uni/FACT/Testdata/20141001_273.drs.fits.gz" />
	<property name="outfile" value="/home/fabian/mount/data/LinuxDaten/uni/FACT/pedestal" />

    <property name="sourcename" value="crab" />
    <property name="core_threshold" value="6.0" />
    <property name="neighbor_threshold" value="3.0"/>
    <property name="time_threshold" value="30.0" />
    <property name="min_number_of_pixel" value="2" />
    <property name="search_window_left" value="35" />
    <property name="search_window_right" value="95" />
    <property name="limit" value="10" />


    <!-- Name des Streams und pfad zu dem Daten-File -->
    <stream id="fact" class="fact.io.zfits.ZFitsStream"  url="file:${infile}" limit="${limit}"/>

    <process id="2" input="fact">
        <fact.utils.PreviousEventInfo startCellKey="StartCellData" outputKey="prevEvents" limitEvents="5"/>
        <stream.flow.Skip condition="%{data.EventNum} &lt; 0" />
        <fact.io.zfits.ZFitsDrsCalib url="file:${infile}" optional="false" outputKey="DataZCal" />
        <fact.filter.DrsCalibration url="file:${drsfile}" key="DataZCal"  outputKey="DataCalibrated"/>
        
        <fact.datacorrection.RemoveSpikes dataKey="DataCalibrated" outputKey="DataCalibrated" startCellKey="StartCellData" leftBorder="6" spikeLimit="20" topSlopeLimit="16" maxSpikeLength="4" outputSpikesKey="Sp" color="#000000" />
        <fact.datacorrection.InterpolateBadPixel key="DataCalibrated"  outputKey="DataCalibrated"
                badChidIds="863,868,297,927,80,873,1093,1094,527,528,721,722" />
          
                
        <fact.filter.MovingAverage key="DataCalibrated" outputKey="DataMovAver" length="9" />                
        <fact.statistics.TimerowFeatures dataKey="DataCalibrated" movingAverageKey="DataMovAver" outputKey="dataStat" searchWindowLeft="${search_window_left}" searchWindowRight="${search_window_right}" />
   		<fact.io.RootASCIIWriter url="file:${outfile}_dataStat.txt" keys="EventNum,dataStat_mean,dataStat_std,dataStat_skewness,dataStat_kurtosis,dataStat_median,dataStat_min,dataStat_max,dataStat_mode,dataStat_quantil25,dataStat_quantil75," />
         <fact.statistics.FastFourierTrafo key="DataCalibrated" outputKey="fft" />
        
        <If condition="%{data.EventNum} &gt;= ${limit}" >
        <fact.io.RootASCIIWriter url="file:${outfile}_hist_fft.txt" keys="EventNum,dataStat_histogram,fftAverage" />
        </If>

        <fact.extraction.MaxAmplitudePosition key="DataCalibrated" searchWindowLeft="${search_window_left}" searchWindowRight="${search_window_right}" outputKey="maxAmplitudePosition"/>
        <fact.extraction.RisingEdgeForPositions dataKey="DataCalibrated" amplitudePositionsKey="maxAmplitudePosition" outputKey="arrivalTime"/>
        <fact.extraction.PhotonCharge dataKey="DataCalibrated" positions="maxAmplitudePosition" outputKey="photoncharge" rangeSearchWindow="25" url="file:src/main/resources/gain_sorted_20131127.csv" />
		        
        <!-- Core: 4,...,8 Neigh: 2  -->
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="4_2" arrivalTimeKey="arrivalTime"
           corePixelThreshold="4" neighborPixelThreshold="2"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="4_2" outputKey="N_4_2" />
        <fact.features.Size showerKey="4_2" photonChargeKey="photoncharge" outputKey="S_4_2" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="5_2" arrivalTimeKey="arrivalTime"
           corePixelThreshold="5" neighborPixelThreshold="2"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="5_2" outputKey="N_5_2" />
        <fact.features.Size showerKey="5_2" photonChargeKey="photoncharge" outputKey="S_5_2" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_2" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="2"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="6_2" outputKey="N_6_2" />
        <fact.features.Size showerKey="6_2" photonChargeKey="photoncharge" outputKey="S_6_2" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="7_2" arrivalTimeKey="arrivalTime"
           corePixelThreshold="7" neighborPixelThreshold="2"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="7_2" outputKey="N_7_2" />
        <fact.features.Size showerKey="7_2" photonChargeKey="photoncharge" outputKey="S_7_2" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="8_2" arrivalTimeKey="arrivalTime"
           corePixelThreshold="8" neighborPixelThreshold="2"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="8_2" outputKey="N_8_2" />
        <fact.features.Size showerKey="8_2" photonChargeKey="photoncharge" outputKey="S_8_2" />
        
        <!-- Core: 4,...,8 Neigh: 3  -->
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="4_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="4" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="4_3" outputKey="N_4_3" />
        <fact.features.Size showerKey="4_3" photonChargeKey="photoncharge" outputKey="S_4_3" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="5_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="5" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="5_3" outputKey="N_5_3" />
        <fact.features.Size showerKey="5_3" photonChargeKey="photoncharge" outputKey="S_5_3" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="6_3" outputKey="N_6_3" />
        <fact.features.Size showerKey="6_3" photonChargeKey="photoncharge" outputKey="S_6_3" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="7_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="7" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="7_3" outputKey="N_7_3" />
        <fact.features.Size showerKey="7_3" photonChargeKey="photoncharge" outputKey="S_7_3" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="8_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="8" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="8_3" outputKey="N_8_3" />
        <fact.features.Size showerKey="8_3" photonChargeKey="photoncharge" outputKey="S_8_3" />
        
        <!-- Core: 5,...,8 Neigh: 4      -->    
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="5_4" arrivalTimeKey="arrivalTime"
           corePixelThreshold="5" neighborPixelThreshold="4"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="5_4" outputKey="N_5_4" />
        <fact.features.Size showerKey="5_4" photonChargeKey="photoncharge" outputKey="S_5_4" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_4" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="4"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="6_4" outputKey="N_6_4" />
        <fact.features.Size showerKey="6_4" photonChargeKey="photoncharge" outputKey="S_6_4" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="7_4" arrivalTimeKey="arrivalTime"
           corePixelThreshold="7" neighborPixelThreshold="4"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="7_4" outputKey="N_7_4" />
        <fact.features.Size showerKey="7_4" photonChargeKey="photoncharge" outputKey="S_7_4" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="8_4" arrivalTimeKey="arrivalTime"
           corePixelThreshold="8" neighborPixelThreshold="4"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="8_4" outputKey="N_8_4" />
        <fact.features.Size showerKey="8_4" photonChargeKey="photoncharge" outputKey="S_8_4" />
        
        <!-- Core: 6,...,8 Neigh: 5  -->
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_5" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="5"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="6_5" outputKey="N_6_5" />
        <fact.features.Size showerKey="6_5" photonChargeKey="photoncharge" outputKey="S_6_5" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="7_5" arrivalTimeKey="arrivalTime"
           corePixelThreshold="7" neighborPixelThreshold="5"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="7_5" outputKey="N_7_5" />
        <fact.features.Size showerKey="7_5" photonChargeKey="photoncharge" outputKey="S_7_5" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="8_5" arrivalTimeKey="arrivalTime"
           corePixelThreshold="8" neighborPixelThreshold="5"
           timeThreshold="30"  minNumberOfPixel="2"/>
        <fact.features.NumberOfPixelInShower showerKey="8_5" outputKey="N_8_5" />
        <fact.features.Size showerKey="8_5" photonChargeKey="photoncharge" outputKey="S_8_5" />
        
        <!-- Core:6 Neigh:3 minNumberOfPixel: 3,4  -->
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_3_3" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="3"/>
        <fact.features.NumberOfPixelInShower showerKey="6_3_3" outputKey="N_6_3_3" />
        <fact.features.Size showerKey="6_3_3" photonChargeKey="photoncharge" outputKey="S_6_3_3" />
        <fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="6_3_4" arrivalTimeKey="arrivalTime"
           corePixelThreshold="6" neighborPixelThreshold="3"
           timeThreshold="30"  minNumberOfPixel="4"/>
        <fact.features.NumberOfPixelInShower showerKey="6_3_4" outputKey="N_6_3_4" />
        <fact.features.Size showerKey="6_3_4" photonChargeKey="photoncharge" outputKey="S_6_3_4" />

		<fact.io.RootASCIIWriter url="file:${outfile}_cleaning.txt" keys="EventNum,N_4_2,S_4_2,N_5_2,S_5_2,N_6_2,S_6_2,N_7_2,S_7_2,N_8_2,S_8_2,N_4_3,S_4_3,N_5_3,S_5_3,N_6_3,S_6_3,N_7_3,S_7_3,N_8_3,S_8_3,N_5_4,S_5_4,N_6_4,S_6_4,N_7_4,S_7_4,N_8_4,S_8_4,N_6_5,S_6_5,N_7_5,S_7_5,N_8_5,S_8_5,N_6_3_3,S_6_3_3,N_6_3_4,S_6_3_4" />
		
		<fact.cleaning.TwoLevelTimeMedian photonChargeKey="photoncharge" outputKey="shower" arrivalTimeKey="arrivalTime"
           corePixelThreshold="${core_threshold}" neighborPixelThreshold="${neighbor_threshold}"
           timeThreshold="${time_threshold}"  minNumberOfPixel="${min_number_of_pixel}"/>
           
        <Skip condition="%{data.shower} == null" />
        
		<fact.features.NumberOfPixelInShower showerKey="shower" outputKey="numPixelInShower" />
            
        <Skip condition="%{data.numPixelInShower} &lt; 5" />
        
        <fact.statistics.ArrayMean key="photoncharge" outputKey="photonchargeMean" />
        <fact.statistics.ArrayMean key="arrivalTime" outputKey="arrivalTimeMean" />
       
        <fact.features.Size showerKey="shower" photonChargeKey="photoncharge" outputKey="Size" />       
        <fact.features.DistributionFromShower weightsKey="photoncharge" showerKey="shower" sizeKey="Size" outputKey="showerDistribution" />
        <fact.features.M3Long weightsKey="photoncharge" showerKey="shower" distribution="showerDistribution" />
        <fact.features.Length distribution="showerDistribution" outputKey="Length" />
        <fact.features.Width distribution="showerDistribution" outputKey="Width" />
        <fact.features.NumberOfIslands key="shower" outputKey="numIslands" />
        <fact.features.Concentration weights="photoncharge" shower="shower" concOneOutputKey="Concentration_onePixel" concTwoOutputKey="Concentration_twoPixel"  />
        <fact.features.ConcentrationCore cogxKey="COGx" cogyKey="COGy" showerPixelKey="shower" photonChargeKey="photoncharge" sizeKey="Size" widthKey="Width" lengthKey="Length" deltaKey="Delta" outputKey="ConcCore" />
        <fact.features.ConcentrationAtCenterOfGravity photonChargeKey="photoncharge" cogxKey="COGx" cogyKey="COGy" sizeKey="Size" outputKey="concCOG" />
        <fact.features.Leakage distribution="showerDistribution" shower="shower" weights="photoncharge" outputKey="Leakage" />
        <fact.features.TimeSpread weightsKey="photoncharge" arrivalTimeKey="arrivalTime" showerKey="shower" outputKey="Timespread" />
        
        <fact.io.RootASCIIWriter url="file:${outfile}_parameter.txt" keys="EventNum,UnixTimeUTC,numPixelInShower,photonchargeMean,arrivalTimeMean,Size,Length,Width,numIslands,Concentration_onePixel,Concentration_twoPixel,ConcCore,concCOG,Leakage,Leakage2,Delta,COGx,COGy,m3l,m3t,M3Long,M3Trans,M4Long,M4Trans,varianceLong,varianceTrans,Timespread,Timespread_weighted" />



    </process>


</container>
