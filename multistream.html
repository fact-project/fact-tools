<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8 at 2019-10-17 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20191017" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Fact Tools &#x2013; Using Multistreams</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="http://www.uni-dortmund.de/" id="bannerLeft"><img src="images/logo_tu.png"  alt="tu logo"/></a></div>
        <div class="pull-right"><a href="./" id="bannerRight"><img src="images/header-bg-topLeft.png"  alt="ls8 logo"/></a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2019-10-17<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.1.3</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
            <li class="nav-header">General</li>
    <li><a href="index.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="publications.html" title="Publications"><span class="none"></span>Publications</a>  </li>
    <li><a href="viewer.html" title="Fact Viewer"><span class="none"></span>Fact Viewer</a>  </li>
    <li><a href="build.html" title="Building"><span class="none"></span>Building</a>  </li>
          <li class="nav-header">Tutorial</li>
    <li><a href="tutorial/index.html" title="FACT Tools Tutorial"><span class="icon-chevron-right"></span>FACT Tools Tutorial</a>  </li>
          <li class="nav-header">Documentation</li>
    <li><a href="quickstart.html" title="Quickstart"><span class="none"></span>Quickstart</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Using Multistreams</a>
  </li>
    <li><a href="aux.html" title="Using Auxiliary Data"><span class="none"></span>Using Auxiliary Data</a>  </li>
    <li><a href="stdAnalysis/standardAnalysis.html" title="Standard Analysis"><span class="icon-chevron-down"></span>Standard Analysis</a>
      <ul class="nav nav-list">
    <li><a href="stdAnalysis/standardSettings.html" title="Standard Settings"><span class="none"></span>Standard Settings</a>  </li>
      </ul>
  </li>
    <li><a href="examples.html" title="Usage Examples"><span class="icon-chevron-down"></span>Usage Examples</a>
      <ul class="nav nav-list">
    <li><a href="example_writing.html" title="Reading and Writing Data"><span class="none"></span>Reading and Writing Data</a>  </li>
    <li><a href="plotting/example_plots.html" title="Plotting Data"><span class="icon-chevron-right"></span>Plotting Data</a>  </li>
      </ul>
  </li>
    <li><a href="programming_examples/programming_example.html" title="Programming Examples"><span class="icon-chevron-right"></span>Programming Examples</a>  </li>
    <li><a href="resources.html" title="Further Resources"><span class="none"></span>Further Resources</a>  </li>
          <li class="nav-header">Download</li>
    <li><a href="download.html" title="Download"><span class="none"></span>Download</a>  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<div class="section">
<h2><a name="Using_Multistreams"></a>Using Multistreams</h2>
<p>You often want to analyze many files at once or sequentially without starting a new fact-tools instance for each data .fits file. This is where multistreams come in handy.</p>
<p>You start a multistream by wrapping your input stream  (any kind of stream will do) in another multistream which handles the processing of multiple files. Heres an example .xml that can utilize multiple CPU cores by using the <tt>copies</tt> property.</p>
<p>As always the process needs be assigned to a specific data source. Since there are <tt>num_copies</tt> copies of the stream and the process in this case, you need a unique <tt>id</tt> for each of these. You can access a specific copy by using the <tt>${copy.id}</tt> property.</p>
<div class="section">
<h3><a name="Using_RecursiveDirectoryStreams"></a>Using RecursiveDirectoryStreams</h3>
<p>This particular MultiStream is quite useful in case you want to analyze a bunch of files in a directory. Monte Carlo data for example is usually split up over several thousand fits files. You specify a pattern to only take into account the filenames containing a certain pattern. In this example we only want to read the files ending with <tt>_Events.fits.gz</tt>. These are the usual filenames for simulated Telescope data written by the simulation program Ceres.</p>

<div>
<div>
<pre class="source">    &lt;container&gt;
        &lt;properties url=&quot;classpath:/default/settings.properties&quot; /&gt;
  
        &lt;!-- Pathes to the input files --&gt;
        &lt;property name=&quot;num_copies&quot; value=&quot;2&quot; /&gt;
    
        &lt;property name=&quot;infile&quot; value=&quot;file:/Users/kai/fact_phido/simulated/ceres/proton_klaus_9/&quot; /&gt;
        &lt;property name=&quot;drsfile&quot; value=&quot;file:src/main/resources/testMcDrsFile.drs.fits.gz&quot; /&gt;
        &lt;property name=&quot;integralGainFile&quot; value=&quot;classpath:/default/defaultIntegralGains.csv&quot; /&gt;
    
        &lt;stream id=&quot;fact:${copy.id}&quot; class=&quot;fact.io.RecursiveDirectoryStream&quot;
                pattern=&quot;_Events.fits.gz&quot; copies=&quot;${num_copies}&quot; url=&quot;${infile}&quot;&gt;
            &lt;stream class=&quot;fact.io.FITSStream&quot; id=&quot;_&quot; limit=&quot;10&quot;/&gt;
        &lt;/stream&gt;
    
        &lt;!-- Description of the process and the corresponding stream --&gt;
        &lt;process id=&quot;2&quot; input=&quot;fact:${copy.id}&quot; copies=&quot;${num_copies}&quot; &gt;
    
            &lt;stream.flow.Skip condition=&quot;%{data.EventNum} &amp;lt; 0&quot; /&gt;
            &lt;fact.io.PrintKeys keys=&quot;MCorsikaEvtHeader.fTotalEnergy&quot; /&gt;
    
            &lt;include url=&quot;classpath:/default/mc/calibration_mc.xml&quot; /&gt;
    
            &lt;include url=&quot;classpath:/default/mc/extraction_mc.xml&quot; /&gt;
    
            &lt;include url=&quot;classpath:/default/mc/cleaning_mc.xml&quot; /&gt;
    
        &lt;/process&gt;
    &lt;/container&gt;
</pre></div></div>

<p>Keep in mind that whenever you&#x2019;re using the <tt>copies</tt> parameter of a stream you have to write out your reuslts to a separate file for each thread. In other words you have to append <tt>${copy.id}</tt> to the filename you&#x2019;re writing to.</p></div>
<div class="section">
<h3><a name="Using__FileListMultiStreams"></a>Using  FileListMultiStreams</h3>
<p>This multistream is useful for analyzing real data files from the telescope. It uses a .json file as a whitelist which contains the paths to the data and drs files.</p>
<p>Here is an example .xml file.</p>

<div>
<div>
<pre class="source">    &lt;property name=&quot;whitelist&quot; value=&quot;some_list.json&quot; /&gt;

    &lt;property name=&quot;num_copies&quot; value=&quot;2&quot; /&gt;

    &lt;service id=&quot;auxFileService&quot; class=&quot;fact.auxservice.AuxFileService&quot; auxFolder=&quot;file:/fact/aux/2013/10/12/&quot; /&gt;


    &lt;stream id=&quot;mystream:${copy.id}&quot; class=&quot;fact.io.FactFileListMultiStream&quot;
            url=&quot;file:${whitelist}&quot; copies=&quot;${num_copies}&quot; &gt;
        &lt;stream class=&quot;fact.io.zfits.ZFitsStream&quot; id=&quot;_&quot; limit=&quot;100&quot;/&gt;
    &lt;/stream&gt;


    &lt;process input=&quot;mystream:${copy.id}&quot; copies=&quot;${num_copies}&quot; &gt;

        &lt;fact.datacorrection.DrsCalibration key=&quot;Data&quot; outputKey=&quot;DataCalibrated&quot;/&gt;
        &lt;fact.features.source.SourcePosition outputKey=&quot;sourcePosition&quot; auxService=&quot;auxFileService&quot;/&gt;

    &lt;/process&gt;
</pre></div></div>

<p>The FactFileListMultiStream takes a json file of the form</p>

<div>
<div>
<pre class="source">  {
 &quot;20131012_168&quot;:{
      &quot;drs_path&quot;:&quot;\/fact\/raw\/2013\/10\/12\/20131012_189.drs.fits.gz&quot;,
      &quot;data_path&quot;:&quot;\fact\/raw\/2013\/10\/12\/20131012_168.fits.gz&quot;
      },
   &quot;20131012_170&quot;:{
      ...
   }
 }
</pre></div></div>

<p>and creates a multistream for the files listed.</p>
<p>The <tt>drsPathKey</tt> and <tt>dataPathKey</tt> parameter define the names of the keys in your .json. So in the example above they would need to be set to &#x201c;drs_path&#x201d; and &#x201c;data_path&#x201d; which are the default values. A key called <tt>@drsFile</tt> will be injected into the DataStream by this multistream.</p>
<p>There a few things to consider when using the FileListMultiStream:</p>
<ol style="list-style-type: decimal">

<li>

<p>When you&#x2019;re using this kind of stream you <i>don&#x2019;t</i>  need to set the <tt>url</tt> parameter of the DrsCalibration processor.</p>
</li>
<li>

<p>Your whitelist can only contain files from <i>one single night</i> since the AuxfileService only watches files from a specific night.</p>
</li>
</ol></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2019.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
