var lightcurve =[[{"start":"2016-5-25T17:05:47.331","end":"2016-5-25T17:06:2.331"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:46.217","end":"2016-5-25T17:05:47.331"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:45.102","end":"2016-5-25T17:05:46.217"},{"signalEvents":0,"backgroundEvents":0,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:43.987","end":"2016-5-25T17:05:45.102"},{"signalEvents":0,"backgroundEvents":0,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:42.844","end":"2016-5-25T17:05:43.987"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:41.729","end":"2016-5-25T17:05:42.844"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:40.615","end":"2016-5-25T17:05:41.729"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:39.501","end":"2016-5-25T17:05:40.615"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:38.386","end":"2016-5-25T17:05:39.501"},{"signalEvents":0,"backgroundEvents":0,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:37.224","end":"2016-5-25T17:05:38.386"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:36.104","end":"2016-5-25T17:05:37.224"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:34.984","end":"2016-5-25T17:05:36.104"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:33.866","end":"2016-5-25T17:05:34.984"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:32.749","end":"2016-5-25T17:05:33.866"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:31.629","end":"2016-5-25T17:05:32.749"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:30.510","end":"2016-5-25T17:05:31.629"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:29.393","end":"2016-5-25T17:05:30.510"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:28.261","end":"2016-5-25T17:05:29.393"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:27.129","end":"2016-5-25T17:05:28.261"},{"signalEvents":0,"backgroundEvents":0,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:26.009","end":"2016-5-25T17:05:27.129"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:24.895","end":"2016-5-25T17:05:26.009"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:23.775","end":"2016-5-25T17:05:24.895"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:22.642","end":"2016-5-25T17:05:23.775"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:21.529","end":"2016-5-25T17:05:22.642"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:20.414","end":"2016-5-25T17:05:21.529"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:19.300","end":"2016-5-25T17:05:20.414"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:18.187","end":"2016-5-25T17:05:19.300"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:17.069","end":"2016-5-25T17:05:18.187"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:15.955","end":"2016-5-25T17:05:17.069"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:14.843","end":"2016-5-25T17:05:15.955"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:13.726","end":"2016-5-25T17:05:14.843"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:12.612","end":"2016-5-25T17:05:13.726"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:11.499","end":"2016-5-25T17:05:12.612"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:10.387","end":"2016-5-25T17:05:11.499"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:9.274","end":"2016-5-25T17:05:10.387"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:8.100","end":"2016-5-25T17:05:9.274"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:6.989","end":"2016-5-25T17:05:8.100"},{"signalEvents":0,"backgroundEvents":0,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:5.877","end":"2016-5-25T17:05:6.989"},{"signalEvents":0,"backgroundEvents":4,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:4.764","end":"2016-5-25T17:05:5.877"},{"signalEvents":0,"backgroundEvents":3,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:3.601","end":"2016-5-25T17:05:4.764"},{"signalEvents":0,"backgroundEvents":2,"numberOfOffRegions":5}],
    [{"start":"2016-5-25T17:05:1.912","end":"2016-5-25T17:05:3.601"},{"signalEvents":0,"backgroundEvents":1,"numberOfOffRegions":5}]];

var formatter = d3.time.format("%Y-%m-%dT%H:%M:%S.%L");

var data = _.map(lightcurve, function(v){
    var range = v[0];
    var value = v[1];
    var date  = formatter.parse(range.start)
    var alpha = 1.0 / value.numberOfOffRegions;
    var excess =  value.signalEvents + 0.5 - value.backgroundEvents * alpha;
    return {"date":date, "excess":excess};
});
var dates = _.map(data,'date');

var bars = d3_time.timeSecond.count(d3.min(dates), d3.max(dates))

var margin = {top: 40, right: 40, bottom: 40, left:40},
    width = 600,
    height = 500;

var domainWidth = width - margin.left - margin.right;
var earliestDate = d3.min(dates);
var latestDate = d3.max(dates);

var maxExcess = d3.max(data, function(d) { return d.excess; })
var minExcess = d3.min(data, function(d) { return d.excess; })
console.log(_.map(data,'excess'))

var x = d3.time.scale()
    .domain([earliestDate, d3.time.second.offset(latestDate, 1)])
    .rangeRound([0, width - margin.left - margin.right]);

var y = d3.scale.linear()
    .domain([minExcess - 0.2, maxExcess  + 0.2])
    .range([height - margin.top - margin.bottom, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .tickValues(dates)
    .tickFormat(d3.time.format('%H:%M:%S'))
    .tickSize(5)
    .tickPadding(8);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient('left')
    .tickPadding(8);

var svg = d3.select('body').append('svg')
    .attr('class', 'chart')
    .attr('width', width)
    .attr('height', height)
    .append('g')
    .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');
var barHeight = 3
svg.selectAll('.chart')
    .data(data)
    .enter().append('rect')
    .attr('class', 'bar')
    .attr('x', function(d) { return x(d.date); })
    .attr('y', function(d) { return y(d.excess) - 0.5* barHeight })
    .attr('width', domainWidth/(bars + 1))
    .attr('height', function(d) {
        console.log(d)
        return barHeight;
    });

svg.append('g')
    .attr('class', 'x axis')
    .attr('transform', 'translate(0, ' + (height - margin.top - margin.bottom) + ')')
    .call(xAxis);

svg.append("line")          // attach a line
    .style("stroke", "gray")  // colour the line
    .attr("x1", x(earliestDate))     // x position of the first end of the line
    .attr("y1", y(0))      // y position of the first end of the line
    .attr("x2", x(latestDate))     // x position of the second end of the line
    .attr("y2", y(0));    // y position of the second end of the line

svg.append('g')
    .attr('class', 'y axis')
    .call(yAxis);